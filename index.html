<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8" />
    <title>MEGSİS İŞ TAKİP by Gökhan Elgül</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23064e3b'%3E%3Cpath d='M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z'/%3E%3C/svg%3E">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/showdown@2.1.0/dist/showdown.min.js"></script>

    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            padding: 0;
            background: #f8fafc;
        }
        #root {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: #e0f2fe;
        }
        .login-container {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        .login-container h2 {
            color: #0c4a6e;
            margin-bottom: 10px;
        }
        .login-container p {
            color: #64748b;
            margin-bottom: 30px;
        }
        .login-container input[type="text"],
        .login-container input[type="password"] {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            box-sizing: border-box;
        }
        .login-container button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background-color: #22c55e;
            color: white;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .login-container button:hover {
            background-color: #16a34a;
        }
        .login-container .error {
            color: #dc2626;
            margin-bottom: 15px;
        }
        .login-container .footer {
            margin-top: 20px;
            font-size: 0.8rem;
            color: #94a3b8;
        }

        .container {
            max-width: 1400px;
            margin: 20px auto;
            background: rgba(255,255,255,0.85);
            border-radius: 12px;
            box-shadow: 0 2px 12px #0001;
            padding: 20px;
            min-height: 80vh;
            display: flex;
            flex-direction: column;
        }
        .header-center {
            text-align: center;
            margin-bottom: 20px;
        }
        .header-center h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: #064e3b;
            margin: 0;
        }
        .header-center h2 {
            font-size: 0.9rem;
            font-weight: 400;
            color: #475569;
            margin: 4px 0 0;
            font-style: italic;
        }
        .landing-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            position: relative;
            overflow: hidden;
            border-radius: 12px;
        }
        .upload-box {
            position: relative;
            z-index: 1;
            border: 2px dashed #94a3b8;
            border-radius: 12px;
            padding: 40px 60px;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
        .upload-box:hover {
            background-color: #e2e8f0;
            border-color: #0284c7;
        }
        .upload-box .upload-icon {
            font-size: 4rem;
            color: #0284c7;
            margin-bottom: 10px;
        }
        .upload-box .upload-text {
            font-size: 1.2rem;
            color: #334155;
            font-weight: 500;
        }
        .upload-box .upload-subtext {
            color: #64748b;
            font-size: 0.9rem;
        }
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }
        .card {
            background: #f1f5f9;
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 1px 4px #0001;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: flex-start;
            min-height: 120px;
        }
        .card:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px #0002;
        }
        .card h3 { margin: 0; font-size: 1.1rem; color: #334155; }
        .card .value { font-size: 1.5rem; color: #1d4ed8; font-weight: bold; margin-top: 4px; }
        .card .subtext { font-size: 0.85rem; color: #475569; margin-top: 2px; }
        .card .chart-container { position: relative; display: flex; justify-content: center; align-items: center; margin-top: 6px; width: 100%; height: 80px; }
        .card canvas { width: 100% !important; height: 100% !important; }
        .controls {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            flex-wrap: wrap;
            background-color: #f8fafc;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        .control-group { display: flex; flex-direction: column; }
        .control-group label { font-size: 0.85rem; margin-bottom: 4px; color: #334155; }
        .control-group select,
        .control-group input,
        .control-group button {
            min-width: 140px; padding: 6px 10px; border-radius: 4px;
            border: 1px solid #d1d5db; background: #fff; cursor: pointer; font-size: 0.9rem;
        }
        .error-message { color: #b91c1c; margin-top: 8px; font-size: 0.9rem; }
        
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: flex; justify-content: center;
            align-items: center; z-index: 2000;
        }
        .modal {
            background: #fff; border-radius: 8px; padding: 0;
            max-width: 90vw; width: auto; max-height: 90vh;
            display: flex; flex-direction: column; box-shadow: 0 4px 20px #0003;
        }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 20px; border-bottom: 1px solid #e5e7eb;
        }
        .modal-header h3 { margin: 0; font-size: 1.2rem; }
        .modal-header .close-btn { background: transparent; border: none; font-size: 1.5rem; cursor: pointer; padding: 0; line-height: 1; }
        .modal-content { padding: 20px; overflow-y: auto; }
        .modal-content:-webkit-full-screen {
            background-color: white;
            padding: 20px;
            overflow: auto;
        }
        .modal-content:-moz-full-screen {
            background-color: white;
            padding: 20px;
            overflow: auto;
        }
        .modal-content:fullscreen {
            background-color: white;
            padding: 20px;
            overflow: auto;
        }
        .modal-footer {
            margin-top: auto; padding: 15px 20px; border-top: 1px solid #e5e7eb;
            display: flex; gap: 10px; justify-content: flex-end; background-color: #f9fafb;
            border-bottom-left-radius: 8px; border-bottom-right-radius: 8px;
        }
        .download-btn {
            background-color: #1d4ed8; color: white; border: none; padding: 8px 15px;
            border-radius: 5px; cursor: pointer; font-size: 0.9rem;
        }
        .excel-download-btn { background-color: #4CAF50; }
        .table-wrapper { position: relative; overflow-x: auto; max-height: 60vh; border-radius: 8px; border: 1px solid #e5e7eb; }
        .datatable-container { margin-top: 24px; }
        .datatable-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 0 5px; }
        .datatable-header h3 { margin: 0; font-size: 1.2rem; color: #334155; }
        table { border-collapse: collapse; width: 100%; font-size: 0.9rem; }
        .datatable-container table { min-width: 1800px; table-layout: fixed; }
        th, td { padding: 10px 14px; border-bottom: 1px solid #e5e7eb; text-align: left; vertical-align: middle; }
        th { background: #f9fafb; position: sticky; top: 0; z-index: 3; font-size: 0.85rem; white-space: nowrap; }
        tr:nth-child(even) td { background: #fafafa; }
        tr:hover td { background: #eef2f7; }
        .datatable-container th:first-child, .datatable-container td:first-child { 
            position: sticky; 
            left: 0; 
            background: inherit; 
            z-index: 2; 
        }
        .col-zemin, .col-personel, .col-kurum-ad, .col-başvuran, .col-tescil-talep-bilgisi, .col-başvuru-açıklama { white-space: normal; word-break: break-word; }
        .datatable-container .col-zemin { min-width: 250px; }
        .charts-below { display: flex; gap: 24px; margin-top: 20px; flex-wrap: nowrap; overflow-x: auto; }
        .chart-card {
            background: #f1f5f9; border-radius: 12px; padding: 14px 16px;
            min-width: 350px; flex: 1; box-shadow: 0 1px 4px #0001;
            display: flex; flex-direction: column; height: auto; position: relative;
        }
        .chart-card .chart-wrapper { height: 150px; width: 100%; margin-bottom: 10px; }
        .chart-card canvas { width: 100% !important; height: 100% !important; }
        .chart-title { font-size: 1rem; color: #334155; margin-bottom: 8px; }
        .zoom-btn {
            position: absolute; top: 10px; right: 10px; background: transparent;
            border: none; font-size: 1.2rem; cursor: pointer; color: #334155; z-index: 10;
        }
        .warning-table-container { margin-top: 24px; padding: 16px; border-radius: 12px; border: 2px solid #ef4444; background: #fef2f2; }
        .warning-table-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .warning-table-header h3 { margin: 0; color: #991b1b; }
        .warning-table-header .button-group { display: flex; gap: 10px; align-items: center; }
        .warning-table-container table { table-layout: auto; }
        .warning-table-container .col-personel { width: 25%; min-width: 180px; }
        .warning-table-container .col-zemin { width: 40%; }
        
        .export-btn {
            background-color: #4CAF50; color: white; border: none; padding: 8px 12px;
            border-radius: 4px; cursor: pointer; font-size: 0.9rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
            transition: background-color 0.3s ease;
        }
        .export-btn:hover { background-color: #388E3C; }
        .personnel-waiting-list {
            margin-top: 15px; border-top: 1px solid #e2e8f0; padding-top: 10px;
            max-height: 250px; overflow-y: auto; position: relative;
        }
        .personnel-waiting-list h4 { margin: 0 0 8px 0; font-size: 0.9rem; color: #475569; }
        .personnel-waiting-list table { width: 100%; }
        .personnel-waiting-list td { padding: 4px 6px; border-bottom: 1px solid #f1f5f9; }
        .personnel-waiting-list td:last-child { text-align: right; font-weight: bold; color: #1e40af; }
        .zoomed-waiting-list-table thead th {
            position: sticky; top: -1px; 
            background-color: #ffffff; z-index: 1;
        }
        .filter-list { display: flex; flex-direction: column; gap: 5px; }
        .filter-item label {
            display: block; padding: 8px; border-radius: 4px; cursor: pointer;
            transition: background-color 0.2s;
        }
        .filter-item input { margin-right: 10px; }
        .filter-item label:hover { background-color: #f1f5f9; }
        
        /* Report Comparison Styles */
        .report-comparison-container {
            margin-top: 24px;
            padding: 20px;
            border-radius: 12px;
            background-color: #fdf4ff; /* purple-50 */
            border: 1px solid #f5d0fe; /* purple-200 */
        }
        .report-comparison-header {
            text-align: center;
            margin-bottom: 16px;
        }
        .report-comparison-header h3 {
            margin: 0;
            color: #701a75; /* purple-800 */
            font-size: 1.3rem;
        }
        .report-comparison-inputs {
            display: flex;
            justify-content: center;
            gap: 20px;
            align-items: center;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
         .report-comparison-inputs .control-group label {
            color: #581c87; /* purple-900 */
        }
        .report-comparison-actions {
            text-align: center;
            margin-top: 10px;
        }
         .report-comparison-actions button {
            background-color: #9333ea; /* purple-600 */
            color: white;
            font-weight: 500;
            padding: 10px 20px;
         }
        .report-comparison-actions button:hover {
            background-color: #7e22ce; /* purple-700 */
        }
        .report-comparison-results {
            margin-top: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        .result-card {
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9d5ff; /* purple-200 */
            text-align: center;
        }
        .result-card h4 {
            margin: 0 0 10px 0;
            color: #581c87;
        }
         .result-card p {
            font-size: 1.5rem;
            font-weight: bold;
            color: #7e22ce;
            margin: 0 0 15px 0;
        }
        .result-card .excel-btn {
            background-color: #166534; /* green-800 */
            color: white;
            font-size: 0.9rem;
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
         .result-card .excel-btn:disabled {
             background-color: #9ca3af;
             cursor: not-allowed;
         }
        
        /* EBYS Reporter Styles */
        .ebys-reporter-container {
            margin-top: 24px;
            padding: 20px;
            border-radius: 12px;
            background-color: #fff7ed; /* orange-50 */
            border: 1px solid #fed7aa; /* orange-200 */
        }

        .ebys-reporter-header h3 {
            margin: 0;
            color: #9a3412; /* orange-800 */
            font-size: 1.3rem;
            text-align: center;
            margin-bottom: 16px;
        }
        
        .ebys-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            align-items: flex-end;
            flex-wrap: wrap;
        }
        
        .ebys-chart-container {
            margin-top: 20px;
            height: 400px;
        }

        @media (max-width: 600px) {
            .dashboard { grid-template-columns: 1fr; }
            .charts-below { flex-direction: column; overflow-x: visible; }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        Chart.register(ChartDataLabels);

        const PROVINCES = ["Adana","Adıyaman","Afyonkarahisar","Ağrı","Amasya","Ankara","Antalya","Artvin","Aydın","Balıkesir","Bilecik","Bingöl","Bitlis","Bolu","Burdur","Bursa","Çanakkale","Çankırı","Çorum","Denizli","Diyarbakır","Edirne","Elazığ","Erzincan","Erzurum","Eskişehir","Gaziantep","Giresun","Gümüşhane","Hakkari","Hatay","Isparta","Mersin","İstanbul","İzmir","Kars","Kastamonu","Kayseri","Kırklareli","Kırşehir","Kocaeli","Konya","Kütahya","Malatya","Manisa","Kahramanmaraş","Mardin","Muğla","Muş","Nevşehir","Niğde","Ordu","Rize","Sakarya","Samsun","Siirt","Sinop","Sivas","Tekirdağ","Tokat","Trabzon","Tunceli","Şanlıurfa","Uşak","Van","Yozgat","Zonguldak","Aksaray","Bayburt","Karaman","Kırıkkale","Batman","Şırnak","Bartın","Ardahan","Iğdır","Yalova","Karabük","Kilis","Osmaniye","Düzce"];
        const ALLOWED_COLS = ["kurum ad","ilçe","başvuru tarihi","fen kayıt tarihi","fen kayıt no","başvuru no","başvuran","işlem","zemin","görevli personel","tescil talep bilgisi","başvuru durumu","başvuru açıklama","iade", "ödeme"];
        const HEADER_KEYWORDS = {"kurum ad":["kurum","ad"],"ilçe":["ilçe", "ad"],"başvuru tarihi":["başvuru","tarih"],"fen kayıt tarihi":["fen","kayıt","tarih"],"fen kayıt no":["fen","kayıt","no"],"başvuru no":["başvuru","no"],"başvuran":["başvuran"],"işlem":["işlem"],"zemin":["zemin"],"görevli personel":["personel"],"tescil talep bilgisi":["tescil","talep","bilgi"],"başvuru durumu":["başvuru","durum"],"başvuru açıklama":["başvuru","açıklama"],"iade":["iade"], "ödeme": ["ödeme"]};
        
        const normalizeHeader = (header) => { if (!header) return ""; let s; try { s = header.normalize('NFD').replace(/[\u0300-\u036f]/g, ''); } catch (e) { s = String(header); } s = s.trim().toLocaleLowerCase('tr').replace(/\s+/g, ' '); s = s.replace(/ı/g, 'i').replace(/İ/g, 'i'); return s; }
        const splitPersonel = (text) => { if (text == null) return []; const str = typeof text === 'string' ? text : String(text); return str.split(/[,;–-]/g).map(s => { let part = s.trim(); const arrowIdx = part.indexOf('=>'); if (arrowIdx !== -1) part = part.slice(0, arrowIdx).trim(); return part.replace(/\s*\(Müh\.\)\s*/, '').trim(); }).filter(Boolean); }
        const parsePersonnelWithStatus = (text) => { if (text == null) return []; const str = typeof text === 'string' ? text : String(text); return str.split(/[,;–-]/g).map(s => { let name = s.trim(); let status = null; const arrowIdx = name.indexOf('=>'); if (arrowIdx !== -1) { const statusRaw = name.slice(arrowIdx + 2).trim().toLocaleLowerCase('tr'); name = name.slice(0, arrowIdx).trim(); if (statusRaw.includes('yapılıyor')) status = 'Yapılıyor'; else if (statusRaw.includes('tamamlandı')) status = 'Tamamlandı'; } name = name.replace(/\s*\(Müh\.\)\s*/, '').trim(); return { name, status }; }).filter(p => p.name); }
        const formatDate = (val) => { if (!val) return ""; if (typeof val === 'number') { const date = XLSX.SSF.parse_date_code(val); if (!date) return ""; return `${date.y}-${String(date.m).padStart(2,'0')}-${String(date.d).padStart(2,'0')}`; } if (typeof val === 'string') { let match = val.match(/^(\d{4}-\d{2}-\d{2})/); if (match) return match[1]; match = val.match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})/); if (match) { const day = String(match[1]).padStart(2, '0'); const month = String(match[2]).padStart(2, '0'); const year = match[3]; return `${year}-${month}-${day}`; } const part = val.split(" ")[0]; const m2 = part.match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})/); if (m2) { const day = String(m2[1]).padStart(2, '0'); const month = String(m2[2]).padStart(2, '0'); const year = m2[3]; return `${year}-${month}-${day}`; } return part; } return val; }
        const formatFenKayitNo = (val) => { if (val == null) return ""; if (typeof val === 'number') return val; if (typeof val === 'string') { const num = parseInt(val.replace(/\D/g,''),10); if (!isNaN(num)) return num; return val; } return val; }
        
        const parseTescilDate = (val) => {
            if (!val || typeof val !== 'string') return null;
            const datePart = val.split(/[\s/]/)[0];
            const match = datePart.match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})/);
            if (match) {
                const day = String(match[1]).padStart(2, '0');
                const month = String(match[2]).padStart(2, '0');
                const year = match[3];
                const date = new Date(`${year}-${month}-${day}`);
                if (!isNaN(date.getTime())) {
                    return date;
                }
            }
            return null;
        }

        const detectProvinceAndDistrict = (rawKurumAd) => {
            if (!rawKurumAd) return { province: null, district: null };
            const normRaw = normalizeHeader(rawKurumAd);
            let province = null, district = null;
        
            for (let p of PROVINCES) {
                const normP = normalizeHeader(p);
                if (normRaw.includes(normP)) {
                    province = p;
                    let after = normRaw.substring(normRaw.indexOf(normP) + normP.length).trim();
                    const hasMerkez = after.includes('merkez');
                    let cleanedAfter = after.replace(/belediyesi|belediye|bld|ilce|ilçe|merkez|buyuksehir|büyükşehir|tapu mudurlugu|kadastro mudurlugu|müdürlüğü|müd/gi, '').trim();

                    if (cleanedAfter.length > 0) {
                        district = cleanedAfter.split(' ')[0].replace(/[^a-zA-ZçğıöşüÇĞİÖŞÜ]/g, '');
                    } else if (hasMerkez) {
                        district = "Merkez";
                    }
                    break; 
                }
            }
            
            if (!province && normRaw.length > 0) {
                let cleanedRaw = normRaw.replace(/belediyesi|belediye|bld|ilce|ilçe|merkez|buyuksehir|büyükşehir|tapu mudurlugu|kadastro mudurlugu|müdürlüğü|müd/gi, '').trim();
                if (cleanedRaw.length > 0) {
                    district = cleanedRaw.split(' ')[0].replace(/[^a-zA-ZçğıöşüÇĞİÖŞÜ]/g, '');
                }
            }

            if (district) {
                district = district.charAt(0).toLocaleUpperCase('tr') + district.slice(1);
            }

            return { province, district };
        }
        const normalizeName = (name) => { if (!name) return ""; return name.toString().trim().toLocaleLowerCase('tr').replace(/\s*\(müh\.\)\s*/g, '').replace(/\s+/g, '').replace(/ı/g, 'i').replace(/ö/g, 'o').replace(/ü/g, 'u').replace(/ş/g, 's').replace(/ç/g, 'c').replace(/ğ/g, 'g');}

        const readExcelPromise = (file, isComparison = false) => {
            return new Promise((resolve, reject) => {
                if (!file) { reject(new Error("Dosya yüklenmedi veya geçersiz dosya.")); return; }
                const validTypes = ['application/vnd.openxmlformats-officedocument.spreadsheetml.sheet','application/vnd.ms-excel'];
                if (!validTypes.includes(file.type) && !file.name.match(/\.xlsx?$|\.xls?$/i)) { reject(new Error("Lütfen .xls veya .xlsx uzantılı bir dosya seçin.")); return; }
                const reader = new FileReader();
                reader.onload = e => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const ws = workbook.Sheets[workbook.SheetNames[0]];
                        let json = XLSX.utils.sheet_to_json(ws, { header: 1, raw: true });
                        if (!json.length) { resolve({rows: [], headers: []}); return; }
                        
                        const rawHeaders = json[0].map(h => h == null ? "" : String(h));
                        
                        if (isComparison) {
                             const rowsAsObjects = XLSX.utils.sheet_to_json(ws);
                             resolve({rows: rowsAsObjects, headers: rawHeaders.filter(h => h)});
                             return;
                        }

                        const headersNorm = rawHeaders.map(h => normalizeHeader(h));
                        const colIndexes = {};
                        
                        const allAllowedCols = [...ALLOWED_COLS, "personel", "bekleme süresi (gün)"];
                        const allHeaderKeywords = {...HEADER_KEYWORDS, "personel": ["personel"], "bekleme süresi (gün)": ["bekleme", "süre"]};

                        allAllowedCols.forEach(col => { colIndexes[col] = -1; });
                        
                        headersNorm.forEach((hNorm, idx) => {
                            for (const canonical of allAllowedCols) {
                                const keywords = allHeaderKeywords[canonical] || [canonical];
                                const allMatch = keywords.every(k => normalizeHeader(k) && hNorm.includes(normalizeHeader(k)));
                                if (allMatch && colIndexes[canonical] === -1) {
                                    colIndexes[canonical] = idx;
                                    break; 
                                }
                            }
                        });
                        
                        // Handle "Personel" vs "Görevli Personel"
                        if (colIndexes["görevli personel"] === -1 && colIndexes["personel"] !== -1) {
                            colIndexes["görevli personel"] = colIndexes["personel"];
                        }


                        const allKurumAd = json.slice(1).map(row => { const idx = colIndexes["kurum ad"]; return idx >= 0 ? String(row[idx] || "") : ""; });
                        let provincesInFile = new Set();
                        for (let kurum of allKurumAd) { const {province} = detectProvinceAndDistrict(kurum); if (province) provincesInFile.add(province); }
                        let singleProvince = (provincesInFile.size === 1) ? Array.from(provincesInFile)[0] : null;
                        
                        const rows = json.slice(1).map(row => {
                            const obj = {};
                            allAllowedCols.forEach(col => {
                                const idx = colIndexes[col];
                                let val = idx >= 0 ? row[idx] : null;
                                if (col==='başvuru tarihi' || col==='fen kayıt tarihi') obj[col]=formatDate(val);
                                else if(col==='fen kayıt no'||col==='başvuru no') obj[col]=formatFenKayitNo(val);
                                else obj[col] = val != null ? val : "";
                            });

                            let kurumAd = String(obj['kurum ad']||'').trim();
                            const { province, district: districtFromKurumAd } = detectProvinceAndDistrict(kurumAd);

                            obj._province = province || (singleProvince || null);

                            let finalDistrict = "";
                            const districtFromIlceCol = obj['ilçe'] ? String(obj['ilçe']).trim() : null;

                            if (districtFromIlceCol) {
                                finalDistrict = districtFromIlceCol;
                            } else if (districtFromKurumAd) {
                                finalDistrict = districtFromKurumAd;
                            }

                            if (finalDistrict) {
                                finalDistrict = finalDistrict.charAt(0).toLocaleUpperCase('tr') + finalDistrict.slice(1).toLocaleLowerCase('tr');
                            }
                            obj._district = finalDistrict;
                            
                            return obj;
                        });
                        resolve({rows, headers: rawHeaders.filter(h => h)});
                    } catch(err) { console.error("readExcelPromise hata:", err); reject(new Error("Dosya okunurken hata oluştu.")); }
                };
                reader.onerror = () => reject(new Error("Dosya okunamadı."));
                try { reader.readAsArrayBuffer(file); } catch(err) { reject(new Error("Dosya okunurken beklenmedik hata oluştu.")); }
            });
        }

        const calcMetrics = (arr) => {
            const today = new Date();
            const threeMonthsAgo = new Date();
            threeMonthsAgo.setMonth(today.getMonth() - 3);

            let toplam = arr.length, count2025 = 0, totalDays = 0, countDays = 0;
            let yearCounts = {}, tescileGiden = 0, tescilEdilen = 0, iade = 0, iptal = 0, fenKayitAlinmayan = 0;
            const overdueFenKayitNos = new Set();
            
            let totalTescilDays = 0;
            let countTescilDays = 0;

            arr.forEach(d => {
                const bStr = d['başvuru tarihi'];
                const fStr = d['fen kayıt tarihi'];
                const fenKayitNo = d['fen kayıt no'];
                const aciklama = String(d['başvuru açıklama'] || '').toLocaleLowerCase('tr');
                const status = String(d['başvuru durumu'] || '').toLocaleLowerCase('tr');
                const odeme = String(d['ödeme'] || '').toLocaleLowerCase('tr');
                const tescilTalepBilgisi = d['tescil talep bilgisi'];

                if (bStr) {
                    const bd = new Date(bStr);
                    if (!isNaN(bd.getTime())) {
                        if (bd.getFullYear() === 2025) count2025++;
                        if (fStr) {
                            const fd = new Date(fStr);
                            if (!isNaN(fd.getTime()) && fd.getFullYear() > 1900 && fd >= threeMonthsAgo) {
                                const diff = (fd - bd) / (1000 * 60 * 60 * 24);
                                if (!isNaN(diff) && diff >= 0) {
                                    totalDays += diff;
                                    countDays++;
                                }
                            }
                        }
                    }
                }
                
                const fenDate = fStr ? new Date(fStr) : null;
                const tescilDate = parseTescilDate(tescilTalepBilgisi);

                if (fenDate && !isNaN(fenDate.getTime()) && fenDate.getFullYear() > 1900 && tescilDate && !isNaN(tescilDate.getTime()) && fenDate >= threeMonthsAgo) {
                    const diff = (tescilDate - fenDate) / (1000 * 60 * 60 * 24);
                    if (diff >= 0) {
                        totalTescilDays += diff;
                        countTescilDays++;
                    }
                }

                const excluded = status.includes('eksiklikten iade edildi') || status.includes('tescile gönderildi');
                
                if (fStr && !excluded) {
                    const fd = new Date(fStr);
                    const hasValidFenKayitNo = fenKayitNo != null && fenKayitNo != 0;
                    if (!isNaN(fd.getTime()) && fd.getFullYear() > 1900 && hasValidFenKayitNo) {
                         const diff = (today - fd) / (1000 * 60 * 60 * 24);
                         if (diff >= 7) { 
                             overdueFenKayitNos.add(fenKayitNo);
                         }
                    }
                }
                
                if(bStr && !excluded) {
                    const bd = new Date(bStr);
                    if (!isNaN(bd.getTime()) && bd.getFullYear() > 1900) {
                        const y = bd.getFullYear();
                        yearCounts[y] = (yearCounts[y] || 0) + 1;
                    }
                }

                if (status.includes('tescile gönderildi')) {
                    tescileGiden++;
                    if (aciklama.includes('tescil edildi')) {
                        tescilEdilen++;
                    }
                    if (aciklama.includes('iptal')) {
                        iptal++;
                    }
                }
                if (status.includes('eksiklikten iade edildi')) {
                    iade++;
                }
                if (odeme.includes('ödendi') && !odeme.includes('ödenmedi') && (fenKayitNo === 0 || fenKayitNo == null)) {
                    fenKayitAlinmayan++;
                }
            });

            const overdue = overdueFenKayitNos.size;
            const avgDays = countDays > 0 ? Math.round(totalDays / countDays) : 0;
            const totalWaiting = Object.values(yearCounts).reduce((a, b) => a + b, 0);
            const avgTescilSuresi = countTescilDays > 0 ? Math.round(totalTescilDays / countTescilDays) : 0;
            return { toplam, count2025, avgDays, overdue, yearCounts, tescileGiden, tescilEdilen, iade, iptal, fenKayitAlinmayan, totalWaiting, avgTescilSuresi };
        }
        
        function Dashboard({ data, filtered, sortField, selectedPersonel, selectedIl, selectedIlce }) { 
            const metrics = calcMetrics(data.filter(d => {
                if (selectedIl.length > 0 && !selectedIl.includes(d._province)) return false;
                if (selectedIlce.length > 0 && !selectedIlce.includes(d._district)) return false;
                if (selectedPersonel.length > 0) {
                    const ppl = splitPersonel(d['görevli personel']);
                    if (!selectedPersonel.some(sp => ppl.includes(sp))) return false;
                }
                return true;
            }));

            const sumRef = useRef(), overdueRef = useRef(), yearRef = useRef(); 
            const sumChartRef = useRef(null), overdueChartRef = useRef(null), yearChartRef = useRef(null); 
            
            useEffect(() => { 
                try { 
                    if (sumRef.current) { if (sumChartRef.current) sumChartRef.current.destroy(); sumChartRef.current = new Chart(sumRef.current, { type:'pie', data:{ labels:['Tümü'], datasets:[{ data:[metrics.toplam], backgroundColor:['hsl(0,70%,60%)'] }] }, options:{ responsive:true, plugins:{ legend:{ display:false } }, maintainAspectRatio:false } }); } 
                    if (overdueRef.current) { if (overdueChartRef.current) overdueChartRef.current.destroy(); overdueChartRef.current = new Chart(overdueRef.current, { type:'pie', data:{ labels:['7+ Gün Bekleyen'], datasets:[{ data:[metrics.overdue], backgroundColor:['#f87171'] }] }, options:{ responsive:true, plugins:{ legend:{ display:false } }, maintainAspectRatio:false } }); } 
                    if (yearRef.current) { if (yearChartRef.current) yearChartRef.current.destroy(); const years = Object.keys(metrics.yearCounts).sort(); const labels = years.map(y=>`${y}: ${metrics.yearCounts[y]}`); const dataVals = years.map(y=>metrics.yearCounts[y]); yearChartRef.current = new Chart(yearRef.current, { type:'pie', data:{ labels, datasets:[{ data:dataVals, backgroundColor: years.map((_,i)=>`hsl(${i*360/years.length},70%,60%)`) }] }, options:{ responsive:true, plugins:{ legend:{ position:'bottom', labels:{ boxWidth:12, padding:8 } }, tooltip:{ enabled:true } }, maintainAspectRatio:false } }); } 
                } catch(err) { console.error("Dashboard chart error:", err); } 
            }, [metrics]); 
            
            const yearLegend = Object.keys(metrics.yearCounts).sort().map((y,i)=>{ const color=`hsl(${i*360/Object.keys(metrics.yearCounts).length},70%,60%)`; return (<div key={y} style={{display:'flex',alignItems:'center',marginTop:'4px'}}><span style={{width:'12px',height:'12px',backgroundColor:color,display:'inline-block',marginRight:'6px',borderRadius:'2px'}}></span><span style={{fontSize:'0.85rem',color:'#334155'}}>{y}: {metrics.yearCounts[y]}</span></div>);}); 
            
            return (
                <div className="dashboard"> 
                    <div className="card"><h3>Toplam İşlem</h3><span className="value">{metrics.toplam}</span><div className="subtext">2025 Başvuru: {metrics.count2025}</div><div className="chart-container"><canvas ref={sumRef}></canvas></div></div> 
                    <div className="card"><h3>F.K. Ort. Süre (Son 3 Ay)</h3><span className="value">{metrics.avgDays} gün</span></div> 
                    <div className="card"><h3>7+ Gün Bekleyen</h3><span className="value">{metrics.overdue}</span><div className="chart-container"><canvas ref={overdueRef}></canvas></div></div> 
                    <div className="card"><h3>Yıla Göre Bekleyen</h3><div className="chart-container"><canvas ref={yearRef}></canvas></div>{yearLegend}</div> 
                    <div className="card">
                        <h3>İşlem Durumları</h3>
                        <div style={{marginTop: '4px'}}>
                            <span style={{fontSize: '0.9rem', color: '#334155'}}>Tescile Giden: </span>
                            <span style={{fontSize: '1.1rem', color: '#1d4ed8', fontWeight: 'bold'}}>{metrics.tescileGiden}</span>
                        </div>
                        <div style={{marginTop: '2px'}}>
                            <span style={{fontSize: '0.9rem', color: '#334155'}}>Tescil Edilen: </span>
                            <span style={{fontSize: '1.1rem', color: '#1d4ed8', fontWeight: 'bold'}}>{metrics.tescilEdilen}</span>
                        </div>
                         <div style={{marginTop: '2px'}}>
                            <span style={{fontSize: '0.9rem', color: '#334155'}}>İptal Edilen: </span>
                            <span style={{fontSize: '1.1rem', color: '#1d4ed8', fontWeight: 'bold'}}>{metrics.iptal}</span>
                        </div>
                        <div style={{marginTop: '2px'}}>
                            <span style={{fontSize: '0.9rem', color: '#334155'}}>İade Edilen: </span>
                            <span style={{fontSize: '1.1rem', color: '#1d4ed8', fontWeight: 'bold'}}>{metrics.iade}</span>
                        </div>
                         <div style={{marginTop: '2px'}}>
                            <span style={{fontSize: '0.9rem', color: '#334155'}}>F.K. Alınmayan: </span>
                            <span style={{fontSize: '1.1rem', color: '#1d4ed8', fontWeight: 'bold'}}>{metrics.fenKayitAlinmayan}</span>
                        </div>
                        <div style={{marginTop: '2px'}}>
                            <span style={{fontSize: '0.9rem', color: '#334155'}}>Ort. İşlem Süresi: </span>
                            <span style={{fontSize: '1.1rem', color: '#1d4ed8', fontWeight: 'bold'}}>{metrics.avgTescilSuresi > 0 ? `${metrics.avgTescilSuresi} gün` : 'N/A'}</span>
                        </div>
                    </div>
                </div>
            ); 
        }
        
        function ChartsBelow({ data, onZoom, personnelChartCardRef, waitingChartCardRef, islemChartCardRef, districtChartCardRef, selectedIl, isEngineer, showOnlyEngineers, onToggleEngineers, sortField }) {
            const totalRef = useRef();
            const dynamicRef = useRef();
            const islemRef = useRef();
            const districtRef = useRef();
            const totalChartRef = useRef(null);
            const dynamicChartRef = useRef(null);
            const islemChartRef = useRef(null);
            const districtChartRef = useRef(null);
            const [personnelStats, setPersonnelStats] = useState({ totals: {}, dynamic: {} });
            const [islemStats, setIslemStats] = useState({});
            const [districtStats, setDistrictStats] = useState({});
            
            let dynamicTitle = "Bekleyen İşlem Sayıları";
            switch(sortField) {
                case 'iade edilen': dynamicTitle = 'İade Edilen İşlem Sayıları'; break;
                case 'tescile_giden': dynamicTitle = 'Tescil Edilen(Tescilden Geldi Yapılmayan)'; break;
                case 'iptal_edilen': dynamicTitle = 'Tapu İptal Edilen(Tescilden Geldi-Eksiklikten İade Yapılmayan)'; break;
                case 'fen_kayit_alinmayan': dynamicTitle = 'Fen Kayıt Alınmayan(Ödemesi Yapılan)'; break;
                case 'plan_ornegi': dynamicTitle = 'Plan Örneği-Teknik Bilgi Belge Bekleyen'; break;
            }

            useEffect(() => {
                if (!data || data.length === 0) {
                    setPersonnelStats({ totals: {}, dynamic: {} });
                    setIslemStats({});
                    setDistrictStats({});
                    return;
                }
                const totalsMap = {};
                const dynamicMap = {};
                const islemMap = {};
                const districtMap = {};

                data.forEach(r => {
                    const personnel = splitPersonel(r['görevli personel']);
                     if (personnel.length > 0) {
                         personnel.forEach(p => {
                             if (p) totalsMap[p] = (totalsMap[p] || 0) + 1;
                         });
                     }
                    
                    const status = String(r['başvuru durumu'] || '').toLocaleLowerCase('tr');
                    const aciklama = String(r['başvuru açıklama'] || '').toLocaleLowerCase('tr');
                    const odeme = String(r['ödeme'] || '').toLocaleLowerCase('tr');
                    const islem = String(r['işlem'] || '').trim();
                    const islemLower = islem.toLowerCase();
                    const district = r._district;
                    const fenKayitNo = r['fen kayıt no']; // Fen Kayıt No'yu al
                    
                    // Populate districtMap for waiting items
                    if (district && !status.includes('eksiklikten iade edildi') && !status.includes('tescile gönderildi')) {
                        districtMap[district] = (districtMap[district] || 0) + 1;
                    }
                    
                    // Populate islemMap with grouping
                    let groupedIslem = islem;
                    if ((islemLower.includes('mahke') && islemLower.includes('plan örneği')) || islemLower.includes('teknik bilgi ve belge örnekleri')) {
                        groupedIslem = 'Plan Örneği';
                    } else if (islemLower.startsWith('ayırma ve yola / yeşil alana terk')) {
                        groupedIslem = 'Ayırma Ve Yola / Yeşil Alana Terk';
                    }
                    if (groupedIslem) {
                        islemMap[groupedIslem] = (islemMap[groupedIslem] || 0) + 1;
                    }

                    // Populate dynamicMap based on sortField
                    let conditionMet = false;
                    switch(sortField) {
                        case 'iade edilen': 
                            if(status.includes('eksiklikten iade edildi')) conditionMet = true;
                            break;
                        case 'tescile_giden':
                            if(status.includes('tescile gönderildi') && aciklama.includes('tescil edildi')) conditionMet = true;
                            break;
                        case 'iptal_edilen':
                            if(status.includes('tescile gönderildi') && aciklama.includes('iptal')) conditionMet = true;
                            break;
                        case 'fen_kayit_alinmayan':
                            // This specific filter already checks for fenKayitNo, so we keep it as is.
                             if(odeme.includes('ödendi') && !odeme.includes('ödenmedi') && (fenKayitNo === 0 || fenKayitNo == null)) conditionMet = true;
                            break;
                        case 'plan_ornegi':
                            const isPlanOrnegi = islemLower === 'plan örneği';
                            const isMahkemePlanOrnegi = islemLower === 'mahkeme plan örneği';
                            const isTeknikBilgi = islemLower === 'teknik bilgi ve belge örnekleri';
                            const isWaiting = !status.includes('eksiklikten iade edildi') && !status.includes('tescile gönderildi');
                            // Also check for valid Fen Kayit No when Plan Örneği is selected
                            if (isWaiting && (isPlanOrnegi || isMahkemePlanOrnegi || isTeknikBilgi) && fenKayitNo != null && fenKayitNo != 0) {
                                 conditionMet = true;
                            }
                            break;
                        default: // This includes the default 'Bekleyen İşlem Sayıları'
                             // Check if it's a waiting task AND has a valid Fen Kayıt No
                            if(!status.includes('eksiklikten iade edildi') && !status.includes('tescile gönderildi') && fenKayitNo != null && fenKayitNo != 0) {
                                conditionMet = true;
                             }
                            break;
                    }

                    if (conditionMet && personnel.length > 0) {
                        personnel.forEach(p => {
                            if (p) dynamicMap[p] = (dynamicMap[p] || 0) + 1;
                        });
                    }
                });
                
                setPersonnelStats({ totals: totalsMap, dynamic: dynamicMap });
                setIslemStats(islemMap);
                setDistrictStats(districtMap);
            }, [data, sortField]);

            const createSortedChart = (canvasRef, chartRef, chartData, label, isNonPersonnelChart = false) => {
                try {
                    if (canvasRef.current) {
                        const sortedData = Object.entries(chartData).sort(([, a], [, b]) => b - a);
                        
                        let labels, dataValues;

                        if (isNonPersonnelChart) {
                            labels = sortedData.map(d => d[0]);
                            dataValues = sortedData.map(d => d[1]);
                        } else {
                            const filteredSortedData = showOnlyEngineers 
                                ? sortedData.filter(([name]) => isEngineer(name)) 
                                : sortedData;
                            
                            labels = filteredSortedData.map(d => isEngineer(d[0]) ? `${d[0]} (Müh.)` : d[0]);
                            dataValues = filteredSortedData.map(d => d[1]);
                        }
                        
                        const totalCount = dataValues.reduce((sum, val) => sum + val, 0);
                        const chartLabel = `${label} (Toplam: ${totalCount})`; // İl bilgisi kaldırıldı


                        if (chartRef.current) chartRef.current.destroy();
                        
                        chartRef.current = new Chart(canvasRef.current, {
                            type: 'bar',
                            data: {
                                labels,
                                datasets: [{
                                    label: chartLabel, // Use updated label
                                    data: dataValues,
                                    backgroundColor: labels.map((_, i) => `hsl(${(i * 360 / labels.length)}, 70%, 60%)`)
                                }]
                            },
                            options: {
                                indexAxis: 'y',
                                responsive: true,
                                plugins: {
                                    title: { // Use title plugin for better display
                                        display: true,
                                        text: chartLabel,
                                        font: { size: 14 } // Adjust font size if needed
                                    },
                                    legend: { display: false },
                                    datalabels: { anchor: 'end', align: 'right', color: '#444', font: { weight: 'bold' } }
                                },
                                scales: { 
                                    y: {
                                        ticks: {
                                            color: (context) => {
                                                if (isNonPersonnelChart) return '#666';
                                                const originalName = context.tick.label.replace(' (Müh.)', '');
                                                return isEngineer(originalName) ? 'red' : '#666';
                                            }
                                        }
                                    },
                                    x: { beginAtZero: true } 
                                },
                                maintainAspectRatio: false
                            }
                        });
                    }
                } catch (err) {
                    console.error("Chart creation error:", err);
                }
            };

            useEffect(() => {
                createSortedChart(totalRef, totalChartRef, personnelStats.totals, 'Personel İşlem Dağılımı');
            }, [personnelStats.totals, isEngineer, showOnlyEngineers]);

            useEffect(() => {
                createSortedChart(dynamicRef, dynamicChartRef, personnelStats.dynamic, dynamicTitle);
            }, [personnelStats.dynamic, isEngineer, showOnlyEngineers, dynamicTitle]);

            useEffect(() => {
                 createSortedChart(islemRef, islemChartRef, islemStats, `İşlem Sayıları`, true);
            }, [islemStats]);

             useEffect(() => {
                 createSortedChart(districtRef, districtChartRef, districtStats, `İlçe Bazlı Bekleyen İşlemler`, true);
            }, [districtStats]);


            if (!data || data.length === 0) return null;

            // Calculate totals for zoom titles
            const personnelTotalsData = showOnlyEngineers ? Object.fromEntries(Object.entries(personnelStats.totals).filter(([name]) => isEngineer(name))) : personnelStats.totals;
            const personnelTotalCount = Object.values(personnelTotalsData).reduce((s, v) => s + v, 0);

            const dynamicTotalsData = showOnlyEngineers ? Object.fromEntries(Object.entries(personnelStats.dynamic).filter(([name]) => isEngineer(name))) : personnelStats.dynamic;
            const dynamicTotalCount = Object.values(dynamicTotalsData).reduce((s, v) => s + v, 0);

            const islemTotalCount = Object.values(islemStats).reduce((s, v) => s + v, 0);
            const districtTotalCount = Object.values(districtStats).reduce((s, v) => s + v, 0);


            return (
                 <div style={{flex: 3, display: 'flex', flexDirection: 'column', gap: '10px', minWidth: '1050px'}}>
                     <div style={{alignSelf: 'center'}}>
                         <label style={{display: 'flex', alignItems: 'center', cursor: 'pointer', fontSize: '0.9rem'}}>
                             <input type="checkbox" checked={showOnlyEngineers} onChange={onToggleEngineers} />
                             Grafiklerde Sadece Mühendisleri Göster
                         </label>
                     </div>
                     <div className="charts-below">
                         <div className="chart-card" ref={personnelChartCardRef}>
                             <button className="zoom-btn" title="Büyüt" onClick={() => onZoom({ type: 'chart', data: personnelTotalsData, title: `Personel İşlem Dağılımı (Toplam: ${personnelTotalCount})` })}>🔍</button>
                             {/* Title is now handled by Chart.js title plugin */}
                             <div className="chart-wrapper" style={{height: '250px'}}><canvas ref={totalRef}></canvas></div>
                         </div>
                         <div className="chart-card" ref={waitingChartCardRef}>
                              <button className="zoom-btn" title="Büyüt" onClick={() => onZoom({ type: 'chart', data: dynamicTotalsData, title: `${dynamicTitle} (Toplam: ${dynamicTotalCount})` })}>🔍</button>
                             {/* Title is now handled by Chart.js title plugin */}
                             <div className="chart-wrapper" style={{height: '250px'}}><canvas ref={dynamicRef}></canvas></div>
                         </div>
                          <div className="chart-card" ref={islemChartCardRef}>
                               <button className="zoom-btn" title="Büyüt" onClick={() => onZoom({ type: 'chart', data: islemStats, title: `İşlem Sayıları (Toplam: ${islemTotalCount})` })}>🔍</button>
                             {/* Title is now handled by Chart.js title plugin */}
                             <div className="chart-wrapper" style={{height: '250px'}}><canvas ref={islemRef}></canvas></div>
                         </div>
                         <div className="chart-card" ref={districtChartCardRef}>
                               <button className="zoom-btn" title="Büyüt" onClick={() => onZoom({ type: 'chart', data: districtStats, title: `İlçe Bazlı Bekleyen İşlemler (Toplam: ${districtTotalCount})` })}>🔍</button>
                             {/* Title is now handled by Chart.js title plugin */}
                             <div className="chart-wrapper" style={{height: '250px'}}><canvas ref={districtRef}></canvas></div>
                         </div>
                     </div>
                 </div>
            );
        }
        
        function SummaryTable({ data, selectedIl, onZoom, summaryTableRef }) { 
            const groupArr = {}; 
            data.forEach(row => { 
                if (!row._province) return; 
                const groupKey = row._province; 
                if (!groupArr[groupKey]) groupArr[groupKey] = []; 
                groupArr[groupKey].push(row); 
            }); 
            const groupKeys = selectedIl.length > 0 ? selectedIl : [...new Set(data.map(d => d._province).filter(Boolean))];
            
            const rows = groupKeys.map(key => { 
                const arr = data.filter(d => d._province === key);
                const m = calcMetrics(arr); 
                return { key, ...m }; 
            }); 
            
            const tableBody = rows.length > 0 ? (
                rows.map(r => (
                    <tr key={r.key}>
                        <td>{r.key}</td>
                        <td>{r.toplam}</td>
                        <td>{r.count2025}</td>
                        <td>{r.avgDays} gün</td>
                        <td>{r.overdue}</td>
                        <td>{r.tescileGiden}</td>
                        <td>{r.iade}</td>
                        <td>{r.totalWaiting}</td>
                    </tr>
                ))
            ) : (
                <tr>
                    <td colSpan={8} style={{textAlign:'center', color:'#6b7280'}}>Veri bulunamadı.</td>
                </tr>
            );

            return ( 
                <div className="chart-card" style={{ position:'relative', minWidth:'auto', flex:'1 1 auto' }} ref={summaryTableRef}> 
                    {groupKeys.length>0 && <button className="zoom-btn" title="Büyüt" onClick={onZoom}>🔍</button>} 
                    <div className="chart-title">Özet Tablo</div> 
                    <div style={{overflowX:'auto',background:'#f1f5f9',borderRadius:'12px',padding:'12px',minWidth:'600px'}}> 
                        <table className="summary-table"> 
                            <thead> 
                                <tr> 
                                    <th>İl</th><th>Toplam İşlem</th><th>2025 Başvuru</th><th>F.K. Ort. Süre</th><th>7+ Gün</th><th>Tescile Giden</th><th>İade</th><th>Toplam Bekleyen</th> 
                                </tr> 
                            </thead> 
                            <tbody> 
                               {tableBody}
                            </tbody> 
                        </table> 
                    </div>
                    <p style={{ fontSize: '0.8rem', color: '#475569', fontStyle: 'italic', marginTop: '12px', textAlign: 'center' }}>
                        * Tablodaki tüm hesaplamalar, o il için filtrelenmiş veri setindeki tüm işlemleri (Devam Eden, Tescile Giden, İade) kapsamaktadır.
                    </p>
                </div> 
            ); 
        }
        
        function WarningTable({ data, isEngineer, showOnlyEngineers, onToggleEngineers, sortField }) { 
            const [warningRows, setWarningRows] = useState([]); 
            const [dateSortOrder, setDateSortOrder] = useState('asc');

            const toggleDateSort = () => {
                setDateSortOrder(prev => prev === 'asc' ? 'desc' : 'asc');
            };

            useEffect(() => {
                const today = new Date();
                let finalRows = [];

                if (sortField === 'onemli_isler') {
                    const oneHundredFiftyDaysAgo = new Date();
                    oneHundredFiftyDaysAgo.setDate(today.getDate() - 150);
                    const groupedTasks = {};

                    data.forEach((d, index) => {
                        const islem = String(d['işlem'] || '').trim();
                        const onemliIslemler = [
                            "3194 Sayılı Kanunun 18. Madde Uygulaması",
                            "Kat İrtifakı Tesisi",
                            "Kat Mülkiyeti Tesisi",
                            "Mülkiyet Raporu"
                        ];

                        if (!onemliIslemler.includes(islem)) return;

                        const fenKayitTarihiStr = d['fen kayıt tarihi'];
                        if (!fenKayitTarihiStr) return; 

                        const fenKayitTarihi = new Date(fenKayitTarihiStr);
                        if (isNaN(fenKayitTarihi.getTime())) return; 
                        
                        const fenKayitNo = d['fen kayıt no'];
                        const key = `${fenKayitNo}-${d['ilçe']}-${index}`;

                        if (fenKayitTarihi && fenKayitTarihi >= oneHundredFiftyDaysAgo) {
                            if (fenKayitNo && !groupedTasks[key]) {
                                groupedTasks[key] = {
                                    fenKayitNo: fenKayitNo,
                                    il: d._province || '',
                                    ilce: d['ilçe'] || '',
                                    islem: d['işlem'] || '',
                                    zemin: d['zemin'] || '',
                                    basvuruDurumu: d['başvuru durumu'] || '',
                                    basvuruAciklama: d['başvuru açıklama'] || '',
                                    personnelRaw: d['görevli personel'] || '',
                                    fenKayitTarihi: d['fen kayıt tarihi'] || ''
                                };
                            }
                        }
                    });
                    finalRows = Object.values(groupedTasks);
                }
                else if (sortField === 'uygun_olmayan_iade') {
                    const oneHundredDaysAgo = new Date();
                    oneHundredDaysAgo.setDate(today.getDate() - 100);
                    const groupedTasks = {};

                    data.forEach((d, index) => {
                        const status = String(d['başvuru durumu'] || '').toLocaleLowerCase('tr');
                        if (!status.includes('eksiklikten iade edildi')) return;

                        const fenKayitTarihiStr = d['fen kayıt tarihi'];
                        if (!fenKayitTarihiStr) return; 

                        const fenKayitTarihi = new Date(fenKayitTarihiStr);
                        if (isNaN(fenKayitTarihi.getTime())) return; 
                        
                        const fenKayitNo = d['fen kayıt no'];
                        const key = `${fenKayitNo}-${d['ilçe']}-${index}`;

                        if (fenKayitTarihi && fenKayitTarihi >= oneHundredDaysAgo) {
                            if (fenKayitNo && !groupedTasks[key]) {
                                groupedTasks[key] = {
                                    fenKayitNo: fenKayitNo,
                                    il: d._province || '',
                                    ilce: d['ilçe'] || '',
                                    islem: d['işlem'] || '',
                                    zemin: d['zemin'] || '',
                                    basvuruDurumu: d['başvuru durumu'] || '',
                                    basvuruAciklama: d['başvuru açıklama'] || '',
                                    personnelRaw: d['görevli personel'] || '',
                                    fenKayitTarihi: d['fen kayıt tarihi'] || ''
                                };
                            }
                        }
                    });
                    finalRows = Object.values(groupedTasks);
                } else {
                    let relevantData = data;
                    if (sortField === 'plan_ornegi') {
                        relevantData = relevantData.filter(d => {
                            const islem = String(d['işlem'] || '').toLocaleLowerCase('tr');
                            return ['plan örneği', 'mahkeme plan örneği', 'teknik bilgi ve belge örnekleri'].includes(islem);
                        });
                    }
                    
                    const groupedTasks = {};
                    const daysThreshold = sortField === 'plan_ornegi' ? 2 : 7;

                    relevantData.forEach((task, index) => {
                        const fStr = task['fen kayıt tarihi'];
                        if (fStr) {
                            const fenKayitDate = new Date(fStr);
                            if (!isNaN(fenKayitDate) && fenKayitDate.getFullYear() > 1900) {
                                const diffDays = (today - fenKayitDate) / (1000 * 60 * 60 * 24);
                                const status = String(task['başvuru durumu'] || '').toLocaleLowerCase('tr');
                                const isClosed = status.includes('eksiklikten iade edildi') || status.includes('tescile gönderildi');
                                const fenKayitNo = task['fen kayıt no'];
                                const hasValidFenKayitNo = fenKayitNo != null && fenKayitNo != 0;
                                if (diffDays >= daysThreshold && !isClosed && hasValidFenKayitNo) {
                                    const key = `${fenKayitNo}-${task['ilçe']}-${index}`;
                                    if (!groupedTasks[key]) {
                                        groupedTasks[key] = {
                                            fenKayitNo: fenKayitNo,
                                            il: task._province || '',
                                            ilce: task['ilçe'] || '',
                                            islem: task['işlem'] || '',
                                            zemin: task['zemin'] || '',
                                            basvuruDurumu: task['başvuru durumu'] || '',
                                            beklemeSuresi: Math.floor(diffDays),
                                            personnelRaw: task['görevli personel'] || '',
                                            fenKayitTarihi: task['fen kayıt tarihi'] || ''
                                        };
                                    }
                                }
                            }
                        }
                    });
                    finalRows = Object.values(groupedTasks).sort((a, b) => b.beklemeSuresi - a.beklemeSuresi);
                }
                
                if (sortField === 'onemli_isler' || sortField === 'uygun_olmayan_iade') {
                    finalRows.sort((a, b) => {
                        const dateA = a.fenKayitTarihi ? new Date(a.fenKayitTarihi) : null;
                        const dateB = b.fenKayitTarihi ? new Date(b.fenKayitTarihi) : null;
                        if (!dateA) return 1;
                        if (!dateB) return -1;
                        return dateSortOrder === 'asc' ? dateA - dateB : dateB - dateA;
                    });
                }

                if (showOnlyEngineers) {
                    finalRows = finalRows.filter(row => parsePersonnelWithStatus(row.personnelRaw).some(p => isEngineer(p.name)));
                }

                setWarningRows(finalRows);
            }, [data, isEngineer, showOnlyEngineers, sortField, dateSortOrder]); 

            const handleExportWarningExcel = () => { 
                const getPersonnelText = (row) => {
                    const personnelListWithStatus = parsePersonnelWithStatus(row.personnelRaw);
                    let personnelList = showOnlyEngineers ? personnelListWithStatus.filter(p => isEngineer(p.name)) : personnelListWithStatus;
                    return personnelList.map(p => {
                        const namePart = isEngineer(p.name) ? `${p.name} (Müh.)` : p.name;
                        const statusPart = (sortField === 'tescilden_geldi' && p.status) ? ` (${p.status})` : '';
                        return `${namePart}${statusPart}`;
                    }).join("\n");
                };

                let dataToExport;
                let cols = [];

                if (sortField === 'uygun_olmayan_iade' || sortField === 'onemli_isler') {
                    dataToExport = warningRows.map(row => ({ 
                        'Personel': getPersonnelText(row),
                        'Fen Kayıt Tarihi': row.fenKayitTarihi,
                        'Fen Kayıt No': row.fenKayitNo, 
                        'İl': row.il, 
                        'İlçe': row.ilce, 
                        'İşlem': row.islem,
                        'Zemin': row.zemin, 
                        'Başvuru Durumu': row.basvuruDurumu,
                        'Başvuru Açıklama': row.basvuruAciklama
                    }));
                    cols = [ { wch: 30 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 20 }, { wch: 40 }, { wch: 25 }, { wch: 50 }];
                } else {
                    dataToExport = warningRows.map(row => ({
                        'Personel': getPersonnelText(row),
                        'Fen Kayıt Tarihi': row.fenKayitTarihi,
                        'Fen Kayıt No': row.fenKayitNo, 
                        'İl': row.il, 
                        'İlçe': row.ilce, 
                        'İşlem': row.islem,
                        'Zemin': row.zemin, 
                        'Başvuru Durumu': row.basvuruDurumu,
                        'Bekleme Süresi (Gün)': row.beklemeSuresi 
                    }));
                    cols = [ { wch: 30 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 20 }, { wch: 40 }, { wch: 25 }, { wch: 20 } ];
                }
                
                const ws = XLSX.utils.json_to_sheet(dataToExport); 
                const range = XLSX.utils.decode_range(ws['!ref']); 
                for (let R = range.s.r + 1; R <= range.e.r; ++R) { 
                    const cell_address = { c: 0, r: R }; 
                    const cell_ref = XLSX.utils.encode_cell(cell_address); 
                    if (ws[cell_ref] && ws[cell_ref].v) { 
                        if (!ws[cell_ref].s) ws[cell_ref].s = {}; 
                        ws[cell_ref].s.alignment = { wrapText: true, vertical: 'top' }; 
                    } 
                } 
                ws['!cols'] = cols; 
                const wb = XLSX.utils.book_new(); 
                XLSX.utils.book_append_sheet(wb, ws, 'Uyari Raporu'); 
                XLSX.writeFile(wb, 'uyari_raporu.xlsx'); 
            }; 

            if (warningRows.length === 0) { return null; } 
            
            const isUygunOlmayanIadeMode = sortField === 'uygun_olmayan_iade';
            const isOnemliIslerMode = sortField === 'onemli_isler';

            const warningTitle = isOnemliIslerMode
                ? `Son 150 Gündeki Önemli İşler (Toplam: ${warningRows.length})`
                : (isUygunOlmayanIadeMode
                    ? `Son 100 Gün İçindeki İadeler (Toplam: ${warningRows.length})`
                    : (sortField === 'plan_ornegi' 
                        ? `2 Günden Fazla Bekleyen İşlemler (Uyarı) (Toplam: ${warningRows.length})`
                        : `7 Günden Fazla Bekleyen İşlemler (Uyarı) (Toplam: ${warningRows.length})`));
            
            return ( 
                <div className="warning-table-container"> 
                    <div className="warning-table-header"> 
                        <h3>{warningTitle}</h3> 
                        <div className="button-group"> 
                             <label style={{display: 'flex', alignItems: 'center', cursor: 'pointer', marginRight: '10px'}}>
                                <input type="checkbox" checked={showOnlyEngineers} onChange={onToggleEngineers} />
                                Sadece Müh. Göster
                            </label>
                            <button onClick={handleExportWarningExcel} className="export-btn" title="Excel olarak indir">Excel İndir</button> 
                        </div> 
                    </div> 
                    <div className="table-wrapper" style={{maxHeight: '300px'}}> 
                        <table> 
                            <thead> 
                                <tr> 
                                    <th className="col-personel">Personel</th>
                                    <th>
                                        Fen Kayıt Tarihi
                                        {(isOnemliIslerMode || isUygunOlmayanIadeMode) && (
                                             <span onClick={toggleDateSort} style={{ cursor: 'pointer', userSelect: 'none', padding: '0 5px' }}>{dateSortOrder === 'asc' ? '🔼' : '🔽'}</span>
                                        )}
                                    </th>
                                    <th className="col-fen-kayit-no">Fen Kayıt No</th> 
                                    <th className="col-il">İl</th> 
                                    <th className="col-ilce">İlçe</th> 
                                    <th className="col-islem">İşlem</th>
                                    <th className="col-zemin">Zemin</th> 
                                    <th>Başvuru Durumu</th>
                                    {isUygunOlmayanIadeMode || isOnemliIslerMode ? <th>Başvuru Açıklama</th> : <th className="col-bekleme-süresi-gün">Bekleme Süresi (Gün)</th> }
                                </tr> 
                            </thead> 
                            <tbody> 
                                {warningRows.map((row, index) => ( 
                                    <tr key={`${row.fenKayitNo}-${row.ilce}-${index}`}> 
                                        <td className="col-personel">
                                            {
                                                parsePersonnelWithStatus(row.personnelRaw)
                                                .filter(p => showOnlyEngineers ? isEngineer(p.name) : true)
                                                .map((p, i, arr) => (
                                                    <React.Fragment key={i}>
                                                        <span style={{ color: isEngineer(p.name) ? 'red' : 'inherit' }}>
                                                            {p.name} {isEngineer(p.name) ? '(Müh.)' : ''}
                                                            {sortField === 'tescilden_geldi' && p.status && ` (${p.status})`}
                                                        </span>
                                                        {i < arr.length - 1 && <br />}
                                                    </React.Fragment>
                                                ))
                                            }
                                        </td>
                                        <td>{row.fenKayitTarihi}</td>
                                        <td className="col-fen-kayit-no">{row.fenKayitNo}</td> 
                                        <td className="col-il">{row.il}</td> 
                                        <td className="col-ilce">{row.ilce}</td> 
                                        <td className="col-islem">{row.islem}</td>
                                        <td className="col-zemin">{row.zemin}</td> 
                                        <td>{row.basvuruDurumu}</td>
                                        {isUygunOlmayanIadeMode || isOnemliIslerMode ? <td style={{whiteSpace: 'normal', wordBreak: 'break-word'}}>{row.basvuruAciklama}</td> : <td className="col-bekleme-süresi-gün">{row.beklemeSuresi}</td>}
                                    </tr> 
                                ))} 
                            </tbody> 
                        </table> 
                    </div> 
                </div> 
            ); 
        }
        
        function DataTable({ data, sortField, isEngineer, showOnlyEngineers, onToggleEngineers }) { 
            const [searchTerm, setSearchTerm] = useState('');
            let rows = [...(data||[])]; 

            if (showOnlyEngineers) {
                rows = rows.filter(row => {
                    const personnel = splitPersonel(row['görevli personel']);
                    return personnel.some(p => isEngineer(p));
                });
            }

            if (searchTerm) {
                rows = rows.filter(row =>
                    String(row['fen kayıt no'] || '').includes(searchTerm)
                );
            }
            
            const exportToExcel = () => {
                try {
                    if (sortField === 'tescilden_geldi') {
                        const headers = ['İLÇE', 'FEN KAYIT NO', 'GÖREVLİ PERSONEL', 'BAŞVURU DURUMU'];
                        const dataForSheet = rows.map(row => [
                            row['ilçe'],
                            row['fen kayıt no'],
                            row['görevli personel'],
                            row['başvuru durumu']
                        ]);

                        const wb = XLSX.utils.book_new();
                        const ws = XLSX.utils.aoa_to_sheet([headers, ...dataForSheet]);
                        
                        rows.forEach((row, rowIndex) => {
                            const cellRef = `C${rowIndex + 2}`;
                            const personelText = row['görevli personel'] || '';
                            if (!personelText || !ws[cellRef]) return;

                            const richText = [];
                            const parts = personelText.split(',').map(p => p.trim());
                            
                            parts.forEach((part, index) => {
                                const subParts = part.split('=>');
                                if (subParts.length === 2 && subParts[1].trim().toLowerCase() === 'yapılıyor') {
                                    const name = subParts[0].trim();
                                    richText.push({ t: name, s: { font: { color: { rgb: "FF0000" } } } });
                                    richText.push({ t: ` => ${subParts[1].trim()}` });
                                } else {
                                    richText.push({ t: part });
                                }
                                if (index < parts.length - 1) {
                                    richText.push({ t: ', ' });
                                }
                            });
                            
                            ws[cellRef].t = 's';
                            ws[cellRef].r = richText;
                            ws[cellRef].v = personelText;
                        });

                        ws['!cols'] = [{ wch: 20 }, { wch: 15 }, { wch: 50 }, { wch: 20 }];
                        XLSX.utils.book_append_sheet(wb, ws, 'Tescilden Geldi');
                        XLSX.writeFile(wb, 'tescilden_geldi.xlsx');
                        return;
                    }
                    
                    const customExportFields = ['tescile_giden', 'iade edilen', 'iptal_edilen', 'fen_kayit_alinmayan', 'plan_ornegi', 'uygun_olmayan_iade', 'onemli_isler'];
                    if (customExportFields.includes(sortField)) {
                        const customHeaders = sortField === 'fen_kayit_alinmayan'
                            ? ['İLÇE', 'BAŞVURU TARİHİ', 'FEN KAYIT NO', 'İŞLEM', 'ZEMİN', 'GÖREVLİ PERSONEL', 'BAŞVURU AÇIKLAMA', 'ÖDEME']
                            : ['İLÇE', 'FEN KAYIT TARİHİ', 'FEN KAYIT NO', 'İŞLEM', 'ZEMİN', 'GÖREVLİ PERSONEL', 'BAŞVURU AÇIKLAMA'];
                        const customCols = sortField === 'fen_kayit_alinmayan'
                            ? ['ilçe', 'başvuru tarihi', 'fen kayıt no', 'işlem', 'zemin', 'görevli personel', 'başvuru açıklama', 'ödeme']
                            : ['ilçe', 'fen kayıt tarihi', 'fen kayıt no', 'işlem', 'zemin', 'görevli personel', 'başvuru açıklama'];
                        
                        const sheetData = [customHeaders];
                        rows.forEach(row => {
                            const rowData = customCols.map(col => {
                                if (col === 'görevli personel') {
                                    let personnel = splitPersonel(row[col]);
                                    if (showOnlyEngineers) {
                                        personnel = personnel.filter(p => isEngineer(p));
                                    }
                                    return personnel.map(p => isEngineer(p) ? `${p} (Müh.)` : p).join(', ');
                                }
                                return row[col];
                            });
                            sheetData.push(rowData);
                        });

                        const ws = XLSX.utils.aoa_to_sheet(sheetData);
                        const wb = XLSX.utils.book_new();
                        XLSX.utils.book_append_sheet(wb, ws, 'Rapor');
                        XLSX.writeFile(wb, `${sortField}.xlsx`);
                    } else {
                        const headers = ALLOWED_COLS.map(col => col.toLocaleUpperCase('tr-TR'));
                        const sheetData = [headers];
                        
                        const redFontStyle = { font: { color: { rgb: "FFFF0000" } } };

                        rows.forEach(row => {
                            const rowData = ALLOWED_COLS.map(col => {
                                if (col === 'görevli personel') {
                                    let personnel = splitPersonel(row[col]);
                                    if (showOnlyEngineers) {
                                        personnel = personnel.filter(p => isEngineer(p));
                                    }
                                    return personnel.map(p => isEngineer(p) ? `${p} (Müh.)` : p).join(', ');
                                }
                                return row[col];
                            });
                            sheetData.push(rowData);
                        });

                        const ws = XLSX.utils.aoa_to_sheet(sheetData);

                        rows.forEach((row, rowIndex) => {
                            ALLOWED_COLS.forEach((col, colIndex) => {
                                const cell_ref = XLSX.utils.encode_cell({c: colIndex, r: rowIndex + 1});
                                if (!ws[cell_ref]) return;

                                let shouldBeRed = false;
                                
                                if (col === 'başvuru açıklama') {
                                    const cellValue = String(row[col] || '').toLocaleLowerCase('tr');
                                    if (cellValue.includes('iptal') || cellValue.includes('tescil edildi')) {
                                        shouldBeRed = true;
                                    }
                                } else if (col === 'görevli personel') {
                                    const personnel = splitPersonel(row[col]);
                                    if (personnel.some(p => isEngineer(p))) {
                                        shouldBeRed = true;
                                    }
                                }

                                if (shouldBeRed) {
                                    ws[cell_ref].s = redFontStyle;
                                }
                            });
                        });
                        
                        const wb = XLSX.utils.book_new(); 
                        XLSX.utils.book_append_sheet(wb, ws, 'Tum_Islemler'); 
                        XLSX.writeFile(wb, 'tum_islemler.xlsx'); 
                    }
                } catch(err) { 
                    console.error("Excel export error:", err);
                    alert("Excel'e aktarma sırasında bir hata oluştu. Lütfen konsolu kontrol edin.");
                } 
            };
            
            if(!rows) return null; 

            const tableBody = rows.length > 0 ? (
                rows.map((row,i) => (
                    <tr key={i}>
                        {ALLOWED_COLS.map(col => {
                            if (col === 'görevli personel') {
                                let personnel = splitPersonel(row[col]);
                                if (showOnlyEngineers) {
                                    personnel = personnel.filter(p => isEngineer(p));
                                }
                                return (
                                    <td key={col} className={`col-${col.replace(/\s+/g, '-')}`}>
                                        {personnel.map((p, i) => (
                                            <React.Fragment key={i}>
                                                <span style={{ color: isEngineer(p) ? 'red' : 'inherit' }}>
                                                    {p} {isEngineer(p) ? '(Müh.)' : ''}
                                                </span>
                                                {i < personnel.length - 1 && ', '}
                                            </React.Fragment>
                                        ))}
                                    </td>
                                );
                            }
                             if (col === 'başvuru açıklama') {
                                 const text = row[col];
                                 if (typeof text !== 'string' || !text) {
                                     return <td key={col} className={`col-${col.replace(/\s+/g, '-')}`}>{text}</td>;
                                 }
                                 const keywords = ['iptal', 'tescil edildi'];
                                 const regex = new RegExp(`(${keywords.join('|')})`, 'gi');
                                 const parts = text.split(regex);
                                 return (
                                     <td key={col} className={`col-${col.replace(/\s+/g, '-')}`}>
                                         {parts.map((part, index) => 
                                             keywords.some(kw => part.toLowerCase() === kw.toLowerCase()) ? 
                                             <span key={index} style={{color: 'red'}}>{part}</span> : 
                                             part
                                         )}
                                     </td>
                                 );
                             }
                            return <td key={col} className={`col-${col.replace(/\s+/g, '-')}`}>{row[col]}</td>
                        })}
                    </tr>
                ))
            ) : (
                <tr>
                    <td colSpan={ALLOWED_COLS.length} style={{textAlign:'center',color:'#6b7280'}}>Kayıt bulunamadı.</td>
                </tr>
            );

            return (
                <div className="datatable-container"> 
                    <div className="datatable-header"> 
                        <h3>Tüm İşlemler</h3> 
                        <div style={{display: 'flex', gap: '10px', alignItems: 'center'}}>
                            <label style={{display: 'flex', alignItems: 'center', cursor: 'pointer'}}>
                                <input type="checkbox" checked={showOnlyEngineers} onChange={onToggleEngineers} />
                                Sadece Müh. Göster
                            </label>
                            <input
                                type="text"
                                placeholder="Fen Kayıt No ile Ara..."
                                value={searchTerm}
                                onChange={e => setSearchTerm(e.target.value)}
                                style={{padding: '6px 10px', borderRadius: '4px', border: '1px solid #d1d5db'}}
                            />
                            <button className="export-btn" onClick={exportToExcel} title="Bu tabloyu Excel olarak indir">Excel İndir</button> 
                        </div>
                    </div> 
                    <div className="table-wrapper" style={{marginTop: 0}}> 
                        <table> 
                            <thead> 
                                <tr>{ALLOWED_COLS.map(col => <th key={col}>{col.toLocaleUpperCase('tr-TR')}</th>)}</tr> 
                            </thead> 
                            <tbody> 
                               {tableBody}
                            </tbody> 
                        </table> 
                    </div> 
                </div>
            ); 
        }
        
        const ZoomedChart = ({ chartData, title, onRender, isForPdf = false, isEngineer }) => {
            const canvasRef = useRef(null);
            const chartRef = useRef(null);

            useEffect(() => {
                if (canvasRef.current && chartData) {
                    if (chartRef.current) {
                        chartRef.current.destroy();
                    }
                    const sortedData = Object.entries(chartData).sort(([, a], [, b]) => b - a);
                    
                    const isPersonnelChart = title.toLowerCase().includes('personel') || title.toLowerCase().includes('bekleyen');

                    const labels = sortedData.map(d => isPersonnelChart && isEngineer(d[0]) ? `${d[0]} (Müh.)` : d[0]);
                    const data = sortedData.map(d => d[1]);
                    
                    chartRef.current = new Chart(canvasRef.current, {
                        type: 'bar',
                        data: {
                            labels,
                            datasets: [{
                                label: title,
                                data,
                                backgroundColor: labels.map((_, i) => `hsl(${(i * 360 / labels.length)}, 70%, 60%)`)
                            }]
                        },
                        options: {
                            indexAxis: 'x', 
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: { display: true, text: title, font: { size: 16 } }, // Title doğrudan kullanılıyor
                                legend: { display: false },
                                datalabels: {
                                    anchor: 'end',
                                    align: 'top',
                                    color: '#444',
                                    font: { weight: 'normal', size: 14 },
                                    formatter: (value) => value > 0 ? value : null,
                                }
                            },
                            scales: {
                                x: { 
                                    beginAtZero: true,
                                    ticks: {
                                        autoSkip: false,
                                        maxRotation: 90,
                                        minRotation: 45,
                                        color: (context) => {
                                            if (!isPersonnelChart) return '#666';
                                            const originalName = context.tick.label.replace(' (Müh.)', '');
                                            return isEngineer(originalName) ? 'red' : '#666';
                                        }
                                    }
                                },
                                y: { beginAtZero: true }
                            },
                            animation: {
                                onComplete: () => { if (onRender) onRender(); }
                            }
                        }
                    });
                }
                return () => {
                    if (chartRef.current) {
                        chartRef.current.destroy();
                        chartRef.current = null;
                    }
                };
            }, [chartData, title, onRender, isEngineer]);

            if (isForPdf) {
                return (
                    <div style={{ width: '100%', height: '100%', position: 'relative' }}>
                        <canvas ref={canvasRef}></canvas>
                    </div>
                );
            }

            const numItems = chartData ? Object.keys(chartData).length : 0;
            const minWidth = numItems * 40; 

            return (
                <div style={{ width: '100%', height: '70vh', overflowX: 'auto' }}>
                    <div style={{ minWidth: `${minWidth}px`, height: '100%', position: 'relative' }}>
                        <canvas ref={canvasRef}></canvas>
                    </div>
                </div>
            );
        };

        const ZoomedSummary = ({ data, selectedIl }) => { return <SummaryTable data={data} selectedIl={selectedIl} onZoom={() => {}} />; };
        
        const ZoomedWaitingList = ({ data, title }) => {
            const tableContent = data.length > 0 ? (
                data.map(item => (
                    <tr key={item.name}>
                        <td style={{width:'80%'}}>{item.name}</td>
                        <td style={{width:'20%', textAlign: 'right'}}>{item.count}</td>
                    </tr>
                ))
            ) : (
                <tr>
                    <td colSpan="2" style={{textAlign:'center', color:'#6b7280'}}>Bekleyen işlem yok.</td>
                </tr>
            );

            return (
                <div style={{minWidth: '400px'}}>
                    <div className="chart-title" style={{textAlign: 'center', fontSize: '1.2rem', marginBottom: '15px'}}>{title}</div>
                    <div style={{maxHeight:'70vh', overflowY:'auto'}}>
                        <table className="zoomed-waiting-list-table">
                            <thead>
                                <tr>
                                    <th style={{position:'sticky', top:0, background: '#fff'}}>Personel</th>
                                    <th style={{textAlign: 'right', position:'sticky', top:0, background: '#fff'}}>Bekleyen İşlem</th>
                                </tr>
                            </thead>
                            <tbody>
                                {tableContent}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        function ReportComparison({ engineers, isEngineer }) {
            const [oldReport, setOldReport] = useState({ data: [], headers: [], name: '' });
            const [newReport, setNewReport] = useState({ data: [], headers: [], name: '' });
            const [comparisonResult, setComparisonResult] = useState(null);
            const [isLoading, setIsLoading] = useState(false);
            const [analyzeEngineersOnly, setAnalyzeEngineersOnly] = useState(false);

            const handleFileChange = async (e, reportType) => {
                const file = e.target.files[0];
                if (!file) return;
                setIsLoading(true);
                try {
                    const { rows, headers } = await readExcelPromise(file, true);
                    const reportData = { data: rows, headers, name: file.name };
                    if (reportType === 'old') {
                        setOldReport(reportData);
                    } else {
                        setNewReport(reportData);
                    }
                } catch (err) {
                    alert(`Hata: ${err.message}`);
                } finally {
                    setIsLoading(false);
                    e.target.value = null;
                }
            };
            
            const findHeader = (headers, keywords) => {
                const normalizedKeywords = keywords.map(k => normalizeHeader(k));
                for (const header of headers) {
                    const normalizedHeader = normalizeHeader(header);
                    if (normalizedKeywords.every(kw => normalizedHeader.includes(kw))) {
                        return header;
                    }
                }
                return null;
            }

            const handleCompare = () => {
                if (oldReport.data.length === 0 || newReport.data.length === 0) {
                    alert("Lütfen her iki raporu da yükleyin.");
                    return;
                }
                
                const fenKayitNoHeaderOld = findHeader(oldReport.headers, ['fen', 'kayıt', 'no']);
                const zeminHeaderOld = findHeader(oldReport.headers, ['zemin']);
                const personelHeaderOld = findHeader(oldReport.headers, ['personel']);

                const oldReportMap = new Map();
                oldReport.data.forEach(row => {
                    const key = (row[fenKayitNoHeaderOld] != null && row[fenKayitNoHeaderOld] != 0) 
                        ? String(row[fenKayitNoHeaderOld])
                        : String(row[zeminHeaderOld] || '');
                    if (key) oldReportMap.set(key, row);
                });

                const fenKayitNoHeaderNew = findHeader(newReport.headers, ['fen', 'kayıt', 'no']);
                const zeminHeaderNew = findHeader(newReport.headers, ['zemin']);

                const newReportMap = new Map();
                newReport.data.forEach(row => {
                     const key = (row[fenKayitNoHeaderNew] != null && row[fenKayitNoHeaderNew] != 0) 
                        ? String(row[fenKayitNoHeaderNew])
                        : String(row[zeminHeaderNew] || '');
                    if (key) newReportMap.set(key, row);
                });

                const completed = [];
                const ongoing = [];
                const added = [];

                oldReportMap.forEach((row, key) => {
                    if (!newReportMap.has(key)) {
                        completed.push(row);
                    } else {
                        ongoing.push(newReportMap.get(key));
                    }
                });

                newReportMap.forEach((row, key) => {
                    if (!oldReportMap.has(key)) {
                        added.push(row);
                    }
                });
                
                if (analyzeEngineersOnly) {
                    const engineerAnalysis = {};
                    const allEngineers = new Set(engineers.map(normalizeName));

                    const processReportForEngineers = (reportData, reportHeaders, targetObject, status) => {
                         const personelHeader = findHeader(reportHeaders, ['personel']);
                         if (!personelHeader) return;

                        reportData.forEach(row => {
                            const personnel = splitPersonel(row[personelHeader]);
                            personnel.forEach(pName => {
                                const normPName = normalizeName(pName);
                                if (allEngineers.has(normPName)) {
                                    if (!targetObject[pName]) {
                                        targetObject[pName] = { completed: [], ongoing: [], added: [] };
                                    }
                                    targetObject[pName][status].push(row);
                                }
                            });
                        });
                    };
                    
                    processReportForEngineers(completed, oldReport.headers, engineerAnalysis, 'completed');
                    processReportForEngineers(ongoing, newReport.headers, engineerAnalysis, 'ongoing');
                    processReportForEngineers(added, newReport.headers, engineerAnalysis, 'added');
                    
                    setComparisonResult({ engineerAnalysis });
                } else {
                     setComparisonResult({
                        completed: { data: completed, headers: oldReport.headers },
                        ongoing: { data: ongoing, headers: newReport.headers },
                        added: { data: added, headers: newReport.headers }
                    });
                }
            };
            
            const exportComparisonToExcel = (data, headers, fileName) => {
                if (data.length === 0) {
                    alert("Dışa aktarılacak veri yok.");
                    return;
                }
                const ws = XLSX.utils.json_to_sheet(data, { header: headers });
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Rapor");
                XLSX.writeFile(wb, `${fileName}.xlsx`);
            };

            const exportEngineerAnalysisToExcel = () => {
                if (!comparisonResult || !comparisonResult.engineerAnalysis) return;
                const wb = XLSX.utils.book_new();

                const summaryData = [];
                summaryData.push(["Mühendis", "Tamamlanan", "Devam Eden", "Yeni Eklenen"]);

                Object.keys(comparisonResult.engineerAnalysis)
                    .sort((a,b) => a.localeCompare(b, 'tr')) // Sort engineers by name
                    .forEach(engineerName => {
                        const analysis = comparisonResult.engineerAnalysis[engineerName];
                        summaryData.push([
                            engineerName,
                            analysis.completed.length,
                            analysis.ongoing.length,
                            analysis.added.length
                        ]);
                    });
                
                const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
                wsSummary['!cols'] = [ { wch: 30 }, { wch: 15 }, { wch: 15 }, { wch: 15 } ];
                XLSX.utils.book_append_sheet(wb, wsSummary, "Özet");
                
                Object.keys(comparisonResult.engineerAnalysis).forEach(engineerName => {
                    const analysis = comparisonResult.engineerAnalysis[engineerName];
                    const sheetData = [];

                    const headers = new Set([...oldReport.headers, ...newReport.headers]);

                    if(analysis.completed.length > 0) {
                        sheetData.push(["--- TAMAMLANAN İŞLER ---"]);
                        sheetData.push(Array.from(headers));
                        analysis.completed.forEach(row => {
                            const rowData = Array.from(headers).map(h => row[h] || "");
                            sheetData.push(rowData);
                        });
                        sheetData.push([]); // Spacer
                    }
                    if(analysis.ongoing.length > 0) {
                        sheetData.push(["--- DEVAM EDEN İŞLER ---"]);
                        sheetData.push(Array.from(headers));
                        analysis.ongoing.forEach(row => {
                            const rowData = Array.from(headers).map(h => row[h] || "");
                            sheetData.push(rowData);
                        });
                         sheetData.push([]); // Spacer
                    }
                     if(analysis.added.length > 0) {
                        sheetData.push(["--- YENİ EKLENEN İŞLER ---"]);
                        sheetData.push(Array.from(headers));
                        analysis.added.forEach(row => {
                            const rowData = Array.from(headers).map(h => row[h] || "");
                            sheetData.push(rowData);
                        });
                    }
                    
                    if (sheetData.length > 0) {
                        const ws = XLSX.utils.aoa_to_sheet(sheetData);
                        XLSX.utils.book_append_sheet(wb, ws, engineerName.substring(0, 31));
                    }
                });

                XLSX.writeFile(wb, "Muhendis_Performans_Analizi.xlsx");
            }

            return (
                 <div className="report-comparison-container">
                    <div className="report-comparison-header">
                        <h3>Rapor Karşılaştırma</h3>
                    </div>
                    <div className="report-comparison-inputs">
                        <div className="control-group">
                            <label>Eski Rapor</label>
                            <input type="file" onChange={(e) => handleFileChange(e, 'old')} accept=".xlsx, .xls" />
                            <span>Seçilen: {oldReport.name}</span>
                        </div>
                        <div className="control-group">
                            <label>Yeni Rapor</label>
                            <input type="file" onChange={(e) => handleFileChange(e, 'new')} accept=".xlsx, .xls" />
                             <span>Seçilen: {newReport.name}</span>
                        </div>
                    </div>
                     <div style={{textAlign: 'center', margin: '15px 0'}}>
                        <label style={{display: 'inline-flex', alignItems: 'center', cursor: 'pointer'}}>
                            <input type="checkbox" checked={analyzeEngineersOnly} onChange={() => {
                                setAnalyzeEngineersOnly(!analyzeEngineersOnly);
                                setComparisonResult(null);
                            }} />
                            Sadece Mühendisleri Analiz Et
                        </label>
                    </div>
                    <div className="report-comparison-actions">
                        <button onClick={handleCompare} disabled={isLoading || oldReport.data.length === 0 || newReport.data.length === 0}>
                            {isLoading ? 'Yükleniyor...' : 'Karşılaştır'}
                        </button>
                    </div>
                    {comparisonResult && (
                        analyzeEngineersOnly ? (
                            <div style={{textAlign: 'center', marginTop: '20px'}}>
                                <button className="excel-btn" style={{backgroundColor: '#7e22ce', padding: '10px 20px'}} onClick={exportEngineerAnalysisToExcel}>
                                    Mühendis Performans Raporunu İndir
                                </button>
                                <p style={{fontSize: '0.9rem', color: '#581c87', marginTop: '10px'}}>
                                    Excel dosyasında her mühendis için ayrı bir sayfa oluşturulacaktır.
                                </p>
                            </div>
                        ) : (
                            <div className="report-comparison-results">
                                <div className="result-card">
                                    <h4>Tamamlanan İşler</h4>
                                    <p>{comparisonResult.completed.data.length} adet</p>
                                    <button 
                                        className="excel-btn"
                                        disabled={comparisonResult.completed.data.length === 0}
                                        onClick={() => exportComparisonToExcel(comparisonResult.completed.data, comparisonResult.completed.headers, 'Tamamlanan_Isler')}
                                    >
                                        Excel İndir
                                    </button>
                                </div>
                                <div className="result-card">
                                    <h4>Yeni Eklenen İşler</h4>
                                    <p>{comparisonResult.added.data.length} adet</p>
                                     <button 
                                        className="excel-btn"
                                        disabled={comparisonResult.added.data.length === 0}
                                        onClick={() => exportComparisonToExcel(comparisonResult.added.data, comparisonResult.added.headers, 'Yeni_Eklenen_Isler')}
                                    >
                                        Excel İndir
                                    </button>
                                </div>
                                <div className="result-card">
                                    <h4>Halen Devam Eden İşler</h4>
                                    <p>{comparisonResult.ongoing.data.length} adet</p>
                                    <button 
                                        className="excel-btn"
                                        disabled={comparisonResult.ongoing.data.length === 0}
                                        onClick={() => exportComparisonToExcel(comparisonResult.ongoing.data, comparisonResult.ongoing.headers, 'Devam_Eden_Isler')}
                                    >
                                        Excel İndir
                                    </button>
                                </div>
                            </div>
                        )
                    )}
                 </div>
            );
        }

        function MegsisReporter({ data, isEngineer }) {
            const [isLoading, setIsLoading] = useState(false);
        
            const handleReportGeneration = () => {
                if (data.length === 0) {
                    alert("Rapor oluşturmak için lütfen önce bir MEGSİS dosyası yükleyin.");
                    return;
                }
        
                setIsLoading(true);
        
                try {
                    const wb = XLSX.utils.book_new();
        
                    const allEngineersInData = [...new Set(
                        data.flatMap(row =>
                            parsePersonnelWithStatus(row['görevli personel'])
                                .filter(p => isEngineer(p.name))
                                .map(p => p.name)
                        )
                    )].sort((a, b) => a.localeCompare(b, 'tr'));
        
                    if (allEngineersInData.length === 0) {
                        alert("Yüklenen dosyada raporlanacak mühendis bulunamadı.");
                        setIsLoading(false);
                        return;
                    }
        
                    allEngineersInData.forEach(engineerName => {
                        let engineerRows = data.filter(row =>
                            parsePersonnelWithStatus(row['görevli personel']).some(p => p.name === engineerName && isEngineer(p.name))
                        );
        
                        engineerRows.sort((a, b) => {
                            const dateA = a['fen kayıt tarihi'] ? new Date(a['fen kayıt tarihi']) : null;
                            const dateB = b['fen kayıt tarihi'] ? new Date(b['fen kayıt tarihi']) : null;
                            if (dateA && dateB) return dateA - dateB;
                            if (dateA) return -1;
                            if (dateB) return 1;
                            return 0;
                        });
        
                        if (engineerRows.length > 0) {
                            const today = new Date();
                            const dataToExport = engineerRows.map(row => {
                                const status = String(row['başvuru durumu'] || '').toLocaleLowerCase('tr');
                                const isClosed = status.includes('eksiklikten iade edildi') || status.includes('tescile gönderildi');
                                const fStr = row['fen kayıt tarihi'];
                                let beklemeSuresi = '';

                                if (fStr && !isClosed) {
                                    const fenKayitDate = new Date(fStr);
                                    if (!isNaN(fenKayitDate) && fenKayitDate.getFullYear() > 1900) {
                                        const diffDays = (today - fenKayitDate) / (1000 * 60 * 60 * 24);
                                        if (diffDays >= 0) {
                                            beklemeSuresi = Math.floor(diffDays);
                                        }
                                    }
                                }

                                return {
                                    'Personel': parsePersonnelWithStatus(row['görevli personel'])
                                        .map(p => isEngineer(p.name) ? `${p.name} (Müh.)` : p.name)
                                        .join("\n"),
                                    'Fen Kayıt Tarihi': row['fen kayıt tarihi'],
                                    'Fen Kayıt No': row['fen kayıt no'],
                                    'İl': row._province,
                                    'İlçe': row._district,
                                    'İşlem': row['işlem'],
                                    'Zemin': row['zemin'],
                                    'Başvuru Durumu': row['başvuru durumu'],
                                    'Bekleme Süresi (Gün)': beklemeSuresi
                                };
                            });
        
                            const ws = XLSX.utils.json_to_sheet(dataToExport);
                            const cols = [{ wch: 30 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 20 }, { wch: 40 }, { wch: 25 }, { wch: 20 }];
                            ws['!cols'] = cols;
        
                            const range = XLSX.utils.decode_range(ws['!ref']);
                            for (let R = range.s.r + 1; R <= range.e.r; ++R) {
                                const cell_address = { c: 0, r: R };
                                const cell_ref = XLSX.utils.encode_cell(cell_address);
                                if (ws[cell_ref] && ws[cell_ref].v) {
                                    if (!ws[cell_ref].s) ws[cell_ref].s = {};
                                    ws[cell_ref].s.alignment = { wrapText: true, vertical: 'top' };
                                }
                            }
        
                            const sheetName = engineerName.replace(/[\\/*?:]/g, "").substring(0, 31);
                            XLSX.utils.book_append_sheet(wb, ws, sheetName);
                        }
                    });
        
                    XLSX.writeFile(wb, 'MEGSIS_Muhendis_Raporu.xlsx');
                } catch (err) {
                    console.error("MEGSİS Rapor oluşturma hatası:", err);
                    alert("Rapor oluşturulurken bir hata oluştu.");
                } finally {
                    setIsLoading(false);
                }
            };
        
            return (
                <div className="ebys-reporter-container" style={{backgroundColor: '#f0f9ff', borderColor: '#bae6fd'}}>
                    <div className="ebys-reporter-header">
                        <h3 style={{color: '#075985'}}>MEGSİS Raporlama</h3>
                    </div>
                    <div className="ebys-controls">
                        <p style={{textAlign: 'center', fontSize: '0.9rem', color: '#0369a1'}}>
                            Yüklenmiş olan MEGSİS verisini kullanarak mühendis bazlı, en eski fen kayıt tarihine göre sıralanmış bir Excel raporu oluşturur.
                        </p>
                        <button onClick={handleReportGeneration} disabled={isLoading || data.length === 0}>
                            {isLoading ? 'Rapor Oluşturuluyor...' : 'Mühendis Bazlı Rapor Al'}
                        </button>
                    </div>
                </div>
            );
        }

        function EbysReporter() {
            const [ebysData, setEbysData] = useState([]);
            const [personnelOptions, setPersonnelOptions] = useState([]);
            const [selectedPersonnel, setSelectedPersonnel] = useState([]);
            const [isLoading, setIsLoading] = useState(false);
            const [reportReady, setReportReady] = useState(false);
            const [fileNames, setFileNames] = useState([]);
            const [totalEbysDocs, setTotalEbysDocs] = useState(0);
            const ebysChartRef = useRef(null);
            const ebysChartInstance = useRef(null);
            
            const parseEbysDate = (val) => {
                if (typeof val === 'number') {
                    const date = XLSX.SSF.parse_date_code(val);
                    if (!date) return null;
                    const dateObj = new Date(date.y, date.m - 1, date.d);
                    if (isNaN(dateObj.getTime())) return null;
                    return dateObj;
                }
                if (typeof val === 'string') {
                    let match = val.match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})/);
                    if (match) {
                        const day = String(match[1]).padStart(2, '0');
                        const month = String(match[2]).padStart(2, '0');
                        const year = match[3];
                        const dateObj = new Date(`${year}-${month}-${day}`);
                        if (!isNaN(dateObj.getTime())) return dateObj;
                    }
                }
                return null;
            };

            const handleFileChange = async (e) => {
                const files = Array.from(e.target.files);
                if (files.length === 0) return;
                setIsLoading(true);
                
                try {
                    const fileReadPromises = files.map(file => readExcelPromise(file, true).then(result => ({...result, fileName: file.name })));
                    const allReports = await Promise.all(fileReadPromises);

                    let currentPersonnel = new Set(personnelOptions);
                    let newRows = [];
                    let newFileNames = [...fileNames];

                    allReports.forEach(report => {
                        if (report.rows.length === 0) return;

                        const personnelHeader = Object.keys(report.rows[0]).find(h => normalizeHeader(h).includes('bekleyen') && (normalizeHeader(h).includes('kullanıcı') || normalizeHeader(h).includes('kullanici')));
                        
                        if (!personnelHeader) {
                            throw new Error(`"${report.fileName}" dosyasında 'İşlemde Bekleyen Kullanıcı' sütunu bulunamadı.`);
                        }
                        if (!newFileNames.includes(report.fileName)) {
                            newFileNames.push(report.fileName);
                        }

                        report.rows.forEach(row => {
                            const personnelName = row[personnelHeader];
                            if (personnelName) {
                                currentPersonnel.add(personnelName);
                            }
                        });
                        newRows.push(...report.rows);
                    });
                    
                    const uniquePersonnel = [...currentPersonnel].sort((a,b) => a.localeCompare(b,'tr'));
                    
                    setPersonnelOptions(uniquePersonnel);
                    const combinedData = [...ebysData, ...newRows];
                    setEbysData(combinedData);
                    setTotalEbysDocs(combinedData.length);
                    setFileNames(newFileNames);

                } catch (err) {
                    alert(`Hata: ${err.message}`);
                } finally {
                    setIsLoading(false);
                     e.target.value = null;
                }
            };
            
            const clearEbysData = () => {
                setEbysData([]);
                setPersonnelOptions([]);
                setSelectedPersonnel([]);
                setFileNames([]);
                setTotalEbysDocs(0);
            };

            const generateReport = () => {
                if (selectedPersonnel.length === 0) {
                    alert("Lütfen en az bir personel seçin.");
                    return;
                }
                 setReportReady(true);
            };
            
             useEffect(() => {
                 if (reportReady && ebysData.length > 0) {
                     const personnelHeader = Object.keys(ebysData[0]).find(h => normalizeHeader(h).includes('bekleyen') && (normalizeHeader(h).includes('kullanıcı') || normalizeHeader(h).includes('kullanici')));
                     const dateHeader = Object.keys(ebysData[0]).find(h => normalizeHeader(h) === 'tarih');
                     
                     const wb = XLSX.utils.book_new();

                     // 1. Create Summary Sheet
                     const summaryData = [];
                     const years = [...new Set(ebysData.map(row => {
                         const date = parseEbysDate(row[dateHeader]);
                         return date ? date.getFullYear() : null;
                     }).filter(Boolean))].sort();

                     const headers = ["Personel", "Toplam Bekleyen", ...years];
                     summaryData.push(headers);
                     
                     const personTotals = {};

                     selectedPersonnel.forEach(personel => {
                         const filteredData = ebysData.filter(row => row[personnelHeader] === personel);
                         const yearCounts = {};
                         years.forEach(y => yearCounts[y] = 0);

                         filteredData.forEach(row => {
                             const date = parseEbysDate(row[dateHeader]);
                             if (date) {
                                 const year = date.getFullYear();
                                 if (yearCounts[year] !== undefined) {
                                     yearCounts[year]++;
                                 }
                             }
                         });

                         const rowData = [
                             personel,
                             filteredData.length,
                             ...years.map(y => yearCounts[y])
                         ];
                         summaryData.push(rowData);
                     });
                     
                     const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
                     wsSummary['!cols'] = [{ wch: 30 }, { wch: 15 }, ...years.map(() => ({ wch: 10 }))];
                     XLSX.utils.book_append_sheet(wb, wsSummary, "Özet");

                     // 2. Create Individual Personnel Sheets
                     selectedPersonnel.forEach(personel => {
                         let filteredData = ebysData.filter(row => row[personnelHeader] === personel);
                         
                         filteredData.sort((a, b) => {
                             const dateA = parseEbysDate(a[dateHeader]);
                             const dateB = parseEbysDate(b[dateHeader]);
                             if (dateA && dateB) return dateA - dateB;
                             if (dateA) return -1;
                             if (dateB) return 1;
                             return 0;
                         });

                         const ws = XLSX.utils.json_to_sheet(filteredData);
                         const sheetName = personel.replace(/[\\/*?:]/g, "").substring(0, 31);
                         XLSX.utils.book_append_sheet(wb, ws, sheetName);
                     });
                     
                     XLSX.writeFile(wb, "EBYS_Personel_Raporu.xlsx");
                     
                     setReportReady(false); // Reset for next report
                 }
             }, [reportReady, ebysData, selectedPersonnel]);

             useEffect(() => {
                 if(ebysData.length > 0 && ebysChartRef.current){
                     const personnelHeader = Object.keys(ebysData[0]).find(h => normalizeHeader(h).includes('bekleyen') && (normalizeHeader(h).includes('kullanıcı') || normalizeHeader(h).includes('kullanici')));
                     const counts = {};
                     ebysData.forEach(row => {
                         const p = row[personnelHeader];
                         if(p) counts[p] = (counts[p] || 0) + 1;
                     });

                     const sortedData = Object.entries(counts).sort(([,a],[,b]) => b - a);
                     const labels = sortedData.map(d => d[0]);
                     const dataValues = sortedData.map(d => d[1]);

                     if(ebysChartInstance.current){
                         ebysChartInstance.current.destroy();
                     }

                     ebysChartInstance.current = new Chart(ebysChartRef.current, {
                         type: 'bar',
                         data: {
                             labels,
                             datasets: [{
                                 label: 'Bekleyen Evrak Sayısı',
                                 data: dataValues,
                                 backgroundColor: labels.map((_, i) => `hsl(${(i * 20)}, 70%, 60%)`),
                             }]
                         },
                         options: {
                             indexAxis: 'y',
                             responsive: true,
                             maintainAspectRatio: false,
                             plugins: {
                                 legend: { display: false },
                                 title: { display: true, text: 'EBYS Personel Bekleyen Evrak Sayıları' },
                                 datalabels: { anchor: 'end', align: 'right', color: '#444', font: { weight: 'bold' } }
                             },
                              scales: { 
                                 x: { beginAtZero: true } 
                             },
                         }
                     });
                 } else {
                      if(ebysChartInstance.current){
                         ebysChartInstance.current.destroy();
                         ebysChartInstance.current = null;
                     }
                 }
             }, [ebysData]);


            return (
                <div className="ebys-reporter-container">
                    <div className="ebys-reporter-header">
                        <h3>EBYS Raporlama</h3>
                    </div>
                    <div className="ebys-controls">
                        <div className="control-group">
                            <label>EBYS Excel Raporu Yükle</label>
                             <input type="file" multiple onChange={handleFileChange} accept=".xlsx, .xls" />
                             {fileNames.length > 0 && <span style={{marginTop: '5px', fontSize: '0.8rem'}}>Seçilenler: {fileNames.join(', ')}</span>}
                             {totalEbysDocs > 0 && <span style={{fontSize: '0.9rem', color: '#78716c', marginTop: '5px'}}>Toplam Bekleyen Evrak: {totalEbysDocs}</span>}
                        </div>
                        {personnelOptions.length > 0 &&
                             <div className="control-group">
                                 <label>Personel Seç</label>
                                 <button onClick={() => document.getElementById('ebys-personnel-modal').style.display = 'flex'}>
                                     {selectedPersonnel.length ? `${selectedPersonnel.length} personel seçili` : 'Personel Seç'}
                                 </button>
                            </div>
                        }
                        <button onClick={generateReport} disabled={isLoading || selectedPersonnel.length === 0}>
                            Rapor Oluştur ve İndir
                        </button>
                        <button onClick={clearEbysData} style={{backgroundColor: '#ef4444', color: 'white'}}>Verileri Temizle</button>
                    </div>

                    {ebysData.length > 0 && 
                        <div className="ebys-chart-container">
                            <canvas ref={ebysChartRef}></canvas>
                        </div>
                    }

                     <div id="ebys-personnel-modal" className="modal-overlay" style={{display: 'none'}} onClick={() => document.getElementById('ebys-personnel-modal').style.display = 'none'}>
                         <div className="modal" onClick={e => e.stopPropagation()}>
                             <div className="modal-header"><h3>Personel Seç</h3><button className="close-btn" onClick={()=> document.getElementById('ebys-personnel-modal').style.display = 'none'}>×</button></div>
                             <div className="modal-content">
                                 <div className="filter-list">
                                     <div className="filter-item" key="select-all">
                                         <label>
                                             <input
                                                 type="checkbox"
                                                 checked={selectedPersonnel.length === personnelOptions.length && personnelOptions.length > 0}
                                                 onChange={e => {
                                                     if (e.target.checked) {
                                                         setSelectedPersonnel(personnelOptions);
                                                     } else {
                                                         setSelectedPersonnel([]);
                                                     }
                                                 }}
                                             />
                                             <b>Tümünü Seç/Bırak</b>
                                         </label>
                                     </div>
                                     {personnelOptions.map(p => <div className="filter-item" key={p}><label>
                                         <input type="checkbox" checked={selectedPersonnel.includes(p)} onChange={e=>{
                                             if(e.target.checked) setSelectedPersonnel([...selectedPersonnel,p]);
                                             else setSelectedPersonnel(selectedPersonnel.filter(sp=>sp!==p));
                                         }}/> {p}
                                     </label></div>)}
                                 </div>
                             </div>
                             <div className="modal-footer">
                                 <button className="download-btn" onClick={()=>{setSelectedPersonnel([]); document.getElementById('ebys-personnel-modal').style.display = 'none';}}>Temizle</button>
                                 <button className="download-btn" style={{backgroundColor: '#16a34a'}} onClick={()=> document.getElementById('ebys-personnel-modal').style.display = 'none'}>Kapat</button>
                             </div>
                         </div>
                     </div>
                </div>
            );
        }

        function App(){
            const [data,setData]=useState([]);
            const [engineers, setEngineers] = useState([]);
            const [loading,setLoading]=useState(false);
            const [errorMsg,setErrorMsg]=useState("");
            const [sortField,setSortField]=useState('');
            const [selectedPersonel,setSelectedPersonel]=useState([]);
            const [selectedIl,setSelectedIl]=useState([]);
            const [selectedIlce, setSelectedIlce] = useState([]); 
            const [showPersonelModal,setShowPersonelModal]=useState(false);
            const [showIlModal,setShowIlModal]=useState(false);
            const [showIlceModal, setShowIlceModal] = useState(false); 
            const [zoomContent, setZoomContent] = useState(null);
            const [showOnlyEngineers, setShowOnlyEngineers] = useState(false);
            const [isFullscreen, setIsFullscreen] = useState(false);
            const [isLoggedIn, setIsLoggedIn] = useState(false);

            const modalContentRef = useRef(null);
            const summaryTableRef = useRef(null);
            const personnelChartRef = useRef(null);
            const waitingChartRef = useRef(null);
            const islemChartRef = useRef(null);
            const districtChartRef = useRef(null);
            
            const readExcelFromUrl = async (url) => {
                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        // Silently fail as requested
                        return [];
                    }
                    const arrayBuffer = await response.arrayBuffer();
                    const data = new Uint8Array(arrayBuffer);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const ws = workbook.Sheets[workbook.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(ws, { header: 1 });
                    return json.flat().filter(name => name != null && name.toString().trim() !== '');
                } catch (error) {
                    // Silently fail as requested
                    return [];
                }
            };
            
            useEffect(() => {
                const fetchEngineers = async () => {
                    const engineerListUrl = 'https://raw.githubusercontent.com/gokhangeo/istakip/main/M%C3%BChendis.xlsx';
                    const engineerNames = await readExcelFromUrl(engineerListUrl);
                    setEngineers(engineerNames.map(String)); 
                };
                fetchEngineers();
            }, []);

            useEffect(() => {
                const handleFullscreenChange = () => {
                    setIsFullscreen(!!document.fullscreenElement);
                };
                document.addEventListener('fullscreenchange', handleFullscreenChange);
                return () => document.removeEventListener('fullscreenchange', handleFullscreenChange);
            }, []);

            const toggleFullscreen = () => {
                const elem = modalContentRef.current;
                if (!document.fullscreenElement) {
                    if (elem.requestFullscreen) {
                        elem.requestFullscreen();
                    } else if (elem.mozRequestFullScreen) { /* Firefox */
                        elem.mozRequestFullScreen();
                    } else if (elem.webkitRequestFullscreen) { /* Chrome, Safari & Opera */
                        elem.webkitRequestFullscreen();
                    } else if (elem.msRequestFullscreen) { /* IE/Edge */
                        elem.msRequestFullscreen();
                    }
                } else {
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                    }
                }
            };

            const isEngineer = (name) => {
                if (!name) return false;
                const normalizedName = normalizeName(name);
                return engineers.some(eng => normalizeName(eng) === normalizedName);
            };

            const handleFile=async(e)=>{
                const files=Array.from(e.target.files||[]);
                if(!files.length) return;
                setLoading(true); setErrorMsg("");
                const newRowsPromises = files.map(f => readExcelPromise(f).catch(err => {
                    console.error('Excel okuma hatası:',err); 
                    setErrorMsg(err.message);
                    return {rows: []};
                }));
                const results = await Promise.all(newRowsPromises);
                const allNewRows = results.flatMap(res => res.rows);
                setData(prevData => [...prevData, ...allNewRows]); 
                e.target.value = null;
                setLoading(false);
            };
            
            const handleDownloadModalAsJpeg = () => {
                const elementToCapture = modalContentRef.current;
                if (elementToCapture) {
                    setLoading(true);
                    html2canvas(elementToCapture, {scale: 2, backgroundColor: '#ffffff'}).then(canvas => {
                        const url = canvas.toDataURL('image/jpeg', 1.0);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `${(zoomContent.title || 'rapor').replace(/[^a-z0-9]/gi, '_')}.jpg`;
                        a.click();
                    }).finally(() => setLoading(false));
                }
            };
            
            const handleExportWaitingListExcel = () => {
                if (zoomContent && zoomContent.type === 'waitingList') {
                    const dataToExport = zoomContent.data.map(i => ({'Personel': i.name, 'Bekleyen İşlem Sayısı': i.count}));
                    const ws = XLSX.utils.json_to_sheet(dataToExport);
                    ws['!cols'] = [{ wch: 30 }, { wch: 20 }];
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, 'Bekleyen_Islemler');
                    XLSX.writeFile(wb, 'bekleyen_islem_sayilari.xlsx');
                }
            };

            const ilOptions = Array.from(new Set(data.map(d=>d._province).filter(p=>p))).sort((a,b)=>a.localeCompare(b,'tr'));
            const ilceOptions = Array.from(new Set(
                data
                .filter(d => selectedIl.length === 0 || selectedIl.includes(d._province))
                .map(d => d._district)
                .filter(p => p)
            )).sort((a,b)=>a.localeCompare(b,'tr'));
            const personnelOptions = Array.from(new Set(data.flatMap(d=>splitPersonel(d['görevli personel'])))).sort((a,b)=>a.localeCompare(b,'tr'));
            const sortOptions=[
                {label:'Sıralama Yok',value:''},
                {label:'Başvuru Tarihine Göre',value:'başvuru tarihi'},
                {label:'Fen Kayıt Tarihine Göre',value:'fen kayıt tarihi'},
                {label:'İade Edilen',value:'iade edilen'},
                {label:'Tescil Edilen', value:'tescile_giden'},
                {label:'Tescilden Geldi', value:'tescilden_geldi'},
                {label:'İptal Edilen', value:'iptal_edilen'},
                {label:'Fen Kayıt Alınmayan', value:'fen_kayit_alinmayan'},
                {label:'Plan Örneği', value:'plan_ornegi'},
                {label:'Bekleyen (Eskiden Yeniye)', value:'bekleyen_eski_yeni'},
                {label:'Bekleyen (Yeniden Eskiye)', value:'bekleyen_yeni_eski'},
                {label:'Uygun Olmayan İade Gerekçeleri', value:'uygun_olmayan_iade'},
                {label:'Önemli İşler', value:'onemli_isler'}
            ];
            
            const filteredData=(() => {
                let arr=[...data];
                if(selectedIl.length>0) arr=arr.filter(d=>selectedIl.includes(d._province));
                if(selectedIlce.length > 0) arr = arr.filter(d => selectedIlce.includes(d._district));
                if(selectedPersonel.length>0) arr=arr.filter(d=>{const ppl=splitPersonel(d['görevli personel']); return selectedPersonel.some(sp=>ppl.includes(sp));});
                
                if(sortField==='iade edilen') {
                    arr=arr.filter(d=>String(d['başvuru durumu']||'').toLocaleLowerCase('tr').includes('eksiklikten iade edildi'));
                } else if (sortField === 'tescile_giden') {
                    arr = arr.filter(d => {
                        const status = String(d['başvuru durumu'] || '').toLocaleLowerCase('tr');
                        const aciklama = String(d['başvuru açıklama'] || '').toLocaleLowerCase('tr');
                        return status.includes('tescile gönderildi') && aciklama.includes('tescil edildi');
                    });
                } else if (sortField === 'tescilden_geldi') {
                    arr = arr.filter(d => String(d['başvuru durumu'] || '').toLocaleLowerCase('tr') === 'tescilden geldi');
                } else if (sortField === 'iptal_edilen') {
                    arr = arr.filter(d => {
                        const status = String(d['başvuru durumu'] || '').toLocaleLowerCase('tr');
                        const aciklama = String(d['başvuru açıklama'] || '').toLocaleLowerCase('tr');
                        return status.includes('tescile gönderildi') && aciklama.includes('iptal');
                    });
                } else if (sortField === 'fen_kayit_alinmayan') {
                    arr = arr.filter(d => {
                        const odeme = String(d['ödeme'] || '').toLocaleLowerCase('tr');
                        return odeme.includes('ödendi') && !odeme.includes('ödenmedi') && (d['fen kayıt no'] === 0 || d['fen kayıt no'] == null);
                    });
                } else if (sortField === 'plan_ornegi') {
                     arr = arr.filter(d => {
                         const islem = String(d['işlem'] || '').toLocaleLowerCase('tr');
                         return ['plan örneği', 'mahkeme plan örneği', 'teknik bilgi ve belge örnekleri'].includes(islem);
                     });
                } else if (sortField === 'bekleyen_eski_yeni') {
                    arr = arr.filter(d => {
                        const status = String(d['başvuru durumu'] || '').toLocaleLowerCase('tr');
                        return !status.includes('eksiklikten iade edildi') && !status.includes('tescile gönderildi');
                    });
                    arr.sort((a, b) => {
                        const dx = new Date(a['başvuru tarihi']);
                        const dy = new Date(b['başvuru tarihi']);
                        if (!isNaN(dx) && !isNaN(dy)) return dx - dy;
                        return 0;
                    });
                } else if (sortField === 'bekleyen_yeni_eski') {
                    arr = arr.filter(d => {
                        const status = String(d['başvuru durumu'] || '').toLocaleLowerCase('tr');
                        return !status.includes('eksiklikten iade edildi') && !status.includes('tescile gönderildi');
                    });
                    arr.sort((a, b) => {
                        const dx = new Date(a['başvuru tarihi']);
                        const dy = new Date(b['başvuru tarihi']);
                        if (!isNaN(dx) && !isNaN(dy)) return dy - dx;
                        return 0;
                    });
                } else if (sortField === 'uygun_olmayan_iade') {
                    arr = arr.filter(d => String(d['başvuru durumu'] || '').toLocaleLowerCase('tr').includes('eksiklikten iade edildi'));
                    arr.sort((a,b) => {
                        const pa = a['görevli personel'] || '';
                        const pb = b['görevli personel'] || '';
                        return pa.localeCompare(pb, 'tr');
                    });
                } else if (sortField === 'onemli_isler') {
                    const onemliIslemler = [
                        "3194 Sayılı Kanunun 18. Madde Uygulaması",
                        "Kat İrtifakı Tesisi",
                        "Kat Mülkiyeti Tesisi",
                        "Mülkiyet Raporu"
                    ];
                    arr = arr.filter(d => onemliIslemler.includes(String(d['işlem'] || '').trim()));
                } else if (sortField) {
                    arr.sort((a, b) => {
                        if (sortField.includes('tarih')) {
                            const dateA = a[sortField] ? new Date(a[sortField]) : null;
                            const dateB = b[sortField] ? new Date(b[sortField]) : null;

                            if (!dateA || isNaN(dateA)) return 1;
                            if (!dateB || isNaN(dateB)) return -1;

                            return dateA - dateB;
                        }
                        const valA = a[sortField] || '';
                        const valB = b[sortField] || '';
                        if (typeof valA === 'string' && typeof valB === 'string') {
                            return valA.localeCompare(valB, 'tr');
                        }
                        return valA < valB ? -1 : valA > valB ? 1 : 0;
                    });
                }
                return arr;
            })();
            
            const LandingPage = ({onFileChange}) => (
                <div className="landing-container">
                    <label htmlFor="file-upload-landing" className="upload-box">
                        <div className="upload-icon">📤</div>
                        <div className="upload-text">Analiz için Excel Dosyası Seçin</div>
                        <div className="upload-subtext">veya dosyayı buraya sürükleyip bırakın</div>
                    </label>
                    <input id="file-upload-landing" type="file" multiple onChange={onFileChange} accept=".xlsx, .xls" style={{display: 'none'}} />
                </div>
            );
            
            if (!isLoggedIn) {
                return <LoginScreen onLogin={() => setIsLoggedIn(true)} />;
            }

            return (<div className="container">
                <div className="header-center">
                    <h1>MEGSİS İŞ TAKİP</h1>
                    <h2 style={{fontStyle: 'italic', fontSize: '0.9rem', color: '#64748b'}}>
                        © Gökhan ELGÜL tarafından tasarlanmıştır.
                    </h2>
                </div>
                
                {loading && <div style={{position:'fixed', top: '50%', left: '50%', transform: 'translate(-50%, -50%)', zIndex: 3000, background: 'rgba(0,0,0,0.7)', color: 'white', padding: '20px', borderRadius: '10px'}}>Yükleniyor...</div>}
                {data.length === 0 && !loading && !errorMsg && <LandingPage onFileChange={handleFile} />}
                {errorMsg && <p className="error-message">{errorMsg}</p>}
                
                {data.length > 0 && <React.Fragment>
                    <div className="controls">
                         <div className="control-group">
                            <label>Dosya İşlemleri</label>
                            <input type="file" multiple onChange={handleFile} accept=".xlsx, .xls" />
                        </div>
                        <div className="control-group">
                            <label>Sıralama</label>
                            <select value={sortField} onChange={e=>setSortField(e.target.value)}>
                                {sortOptions.map(o=><option key={o.value} value={o.value}>{o.label}</option>)}
                            </select>
                        </div>
                        <div className="control-group">
                            <label>İl Filtresi</label>
                            <button onClick={()=>setShowIlModal(true)}>{selectedIl.length ? `${selectedIl.length} il seçili` : 'İl Seç'}</button>
                        </div>
                        <div className="control-group">
                            <label>İlçe Filtresi</label>
                            <button onClick={()=>setShowIlceModal(true)} disabled={ilceOptions.length === 0}>
                                {selectedIlce.length ? `${selectedIlce.length} ilçe seçili` : 'İlçe Seç'}
                            </button>
                        </div>
                        <div className="control-group">
                            <label>Personel Filtresi</label>
                            <button onClick={()=>setShowPersonelModal(true)}>{selectedPersonel.length ? `${selectedPersonel.length} personel seçili` : 'Personel Seç'}</button>
                        </div>
                         <div className="control-group">
                            <label>Veri Yönetimi</label>
                            <button onClick={() => { setData([]); setSelectedIl([]); setSelectedPersonel([]); setSelectedIlce([]); }} style={{backgroundColor: '#ef4444', color: 'white'}}>Verileri Temizle</button>
                        </div>
                    </div>
                    <Dashboard data={data} filtered={filteredData} sortField={sortField} selectedPersonel={selectedPersonel} selectedIl={selectedIl} selectedIlce={selectedIlce} />
                    <div>
                        <div className="charts-below">
                            <ChartsBelow data={filteredData} onZoom={setZoomContent} personnelChartCardRef={personnelChartRef} waitingChartCardRef={waitingChartRef} islemChartCardRef={islemChartRef} districtChartCardRef={districtChartRef} selectedIl={selectedIl} isEngineer={isEngineer} showOnlyEngineers={showOnlyEngineers} onToggleEngineers={() => setShowOnlyEngineers(!showOnlyEngineers)} sortField={sortField} />
                        </div>
                        <div style={{marginTop: '24px'}}>
                            <SummaryTable data={data} selectedIl={selectedIl} onZoom={() => setZoomContent({type: 'summary'})} summaryTableRef={summaryTableRef} />
                        </div>
                    </div>
                    <WarningTable data={filteredData} isEngineer={isEngineer} showOnlyEngineers={showOnlyEngineers} onToggleEngineers={() => setShowOnlyEngineers(!showOnlyEngineers)} sortField={sortField} />
                    <DataTable data={filteredData} sortField={sortField} isEngineer={isEngineer} showOnlyEngineers={showOnlyEngineers} onToggleEngineers={() => setShowOnlyEngineers(!showOnlyEngineers)} />
                    
                    <ReportComparison engineers={engineers} isEngineer={isEngineer} />
                    <MegsisReporter data={data} isEngineer={isEngineer} />
                    <EbysReporter />
                </React.Fragment>}
                
                {zoomContent && (
                    <div className="modal-overlay" onClick={() => setZoomContent(null)}>
                        <div className="modal" onClick={e => e.stopPropagation()}>
                           <div className="modal-header">
                                <h3>{zoomContent.title || 'Büyük Görünüm'}</h3>
                                <button className="close-btn" onClick={() => setZoomContent(null)}>×</button>
                           </div>
                           <div className="modal-content" ref={modalContentRef}>
                                {zoomContent.type === 'chart' && <ZoomedChart chartData={zoomContent.data} title={zoomContent.title} isEngineer={isEngineer} />}
                                {zoomContent.type === 'summary' && <ZoomedSummary data={filteredData} selectedIl={selectedIl} />}
                                {zoomContent.type === 'waitingList' && <ZoomedWaitingList data={zoomContent.data} title={zoomContent.title} />}
                           </div>
                           <div className="modal-footer">
                                <button className="download-btn" onClick={toggleFullscreen}>
                                    {isFullscreen ? 'Tam Ekrandan Çık' : 'Tam Ekran'}
                                </button>
                                {zoomContent.type === 'waitingList' ?
                                    <button className="download-btn excel-download-btn" onClick={handleExportWaitingListExcel}>Excel İndir</button>
                                    :
                                    <button className="download-btn" onClick={handleDownloadModalAsJpeg}>JPEG İndir</button>
                                }
                           </div>
                        </div>
                    </div>
                )}

                {showIlModal && (
                    <div className="modal-overlay" onClick={() => setShowIlModal(false)}>
                        <div className="modal" onClick={e => e.stopPropagation()}>
                            <div className="modal-header"><h3>İl Seç</h3><button className="close-btn" onClick={()=>setShowIlModal(false)}>×</button></div>
                            <div className="modal-content">
                                <div className="filter-list">
                                    {ilOptions.map(il => <div className="filter-item" key={il}><label>
                                        <input type="checkbox" checked={selectedIl.includes(il)} onChange={e=>{
                                            if(e.target.checked) setSelectedIl([...selectedIl,il]);
                                            else setSelectedIl(selectedIl.filter(p=>p!==il));
                                        }}/> {il}
                                    </label></div>)}
                                </div>
                            </div>
                            <div className="modal-footer"><button className="download-btn" onClick={()=>{setSelectedIl([]); setShowIlModal(false);}}>Temizle & Kapat</button></div>
                        </div>
                    </div>
                )}
                {showIlceModal && (
                    <div className="modal-overlay" onClick={() => setShowIlceModal(false)}>
                        <div className="modal" onClick={e => e.stopPropagation()}>
                            <div className="modal-header"><h3>İlçe Seç</h3><button className="close-btn" onClick={()=>setShowIlceModal(false)}>×</button></div>
                            <div className="modal-content">
                                <div className="filter-list">
                                    {ilceOptions.map(ilce => <div className="filter-item" key={ilce}><label>
                                        <input type="checkbox" checked={selectedIlce.includes(ilce)} onChange={e=>{
                                            if(e.target.checked) setSelectedIlce([...selectedIlce, ilce]);
                                            else setSelectedIlce(selectedIlce.filter(i => i !== ilce));
                                        }}/> {ilce}
                                    </label></div>)}
                                </div>
                            </div>
                            <div className="modal-footer"><button className="download-btn" onClick={()=>{setSelectedIlce([]); setShowIlceModal(false);}}>Temizle & Kapat</button></div>
                        </div>
                    </div>
                )}
                {showPersonelModal && (
                    <div className="modal-overlay" onClick={() => setShowPersonelModal(false)}>
                        <div className="modal" onClick={e => e.stopPropagation()}>
                             <div className="modal-header"><h3>Personel Seç</h3><button className="close-btn" onClick={()=>setShowPersonelModal(false)}>×</button></div>
                             <div className="modal-content">
                                <div className="filter-list">
                                    {personnelOptions.map(p => <div className="filter-item" key={p}><label style={{color: isEngineer(p) ? 'red' : 'inherit'}}>
                                        <input type="checkbox" checked={selectedPersonel.includes(p)} onChange={e=>{
                                            if(e.target.checked) setSelectedPersonel([...selectedPersonel,p]);
                                            else setSelectedPersonel(selectedPersonel.filter(sp=>sp!==p));
                                        }}/> {p} {isEngineer(p) ? '(Müh.)' : ''}
                                    </label></div>)}
                                </div>
                            </div>
                            <div className="modal-footer"><button className="download-btn" onClick={()=>{setSelectedPersonel([]); setShowPersonelModal(false);}}>Temizle & Kapat</button></div>
                        </div>
                    </div>
                )}
            </div>);
        }

        const LoginScreen = ({ onLogin }) => {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');

            const users = {
                "mersinkm": "503344",
                "HATAYBM": "334450",
                "ELAZIĞKM": "232323",
                "ELAZIĞBM": "232323"
            };

            const handleLogin = () => {
                let userToCheck = username;
                // Special case for 'mersinkm' - it's already lowercase in users object
                if (username.toLowerCase() !== 'mersinkm') {
                    userToCheck = username.toUpperCase();
                }

                if (users[userToCheck] && users[userToCheck] === password) {
                    onLogin();
                } else {
                    setError('Kullanıcı adı veya şifre hatalı.');
                }
            };

            return (
                <div className="login-container">
                    <h2>MEGSİS İŞ TAKİP</h2>
                    <p>Devam etmek için lütfen giriş yapın.</p>
                    <input 
                        type="text" 
                        placeholder="Kullanıcı Adı" 
                        value={username} 
                        onChange={e => setUsername(e.target.value)} 
                    />
                    <input 
                        type="password" 
                        placeholder="Şifre" 
                        value={password}
                        onChange={e => setPassword(e.target.value)}
                        onKeyPress={e => e.key === 'Enter' && handleLogin()}
                    />
                    {error && <p className="error">{error}</p>}
                    <button onClick={handleLogin}>Giriş Yap</button>
                    <div className="footer">
                        © Gökhan ELGÜL tarafından tasarlanmıştır.
                    </div>
                </div>
            );
        };
        
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>

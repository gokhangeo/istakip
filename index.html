<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8" />
    <title>MEGSƒ∞S ƒ∞≈û TAKƒ∞P by G√∂khan Elg√ºl</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/showdown@2.1.0/dist/showdown.min.js"></script>

    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            padding: 0;
            background: #f8fafc;
        }
        .container {
            max-width: 1400px;
            margin: 20px auto;
            background: rgba(255,255,255,0.85);
            border-radius: 12px;
            box-shadow: 0 2px 12px #0001;
            padding: 20px;
            min-height: 80vh;
            display: flex;
            flex-direction: column;
        }
        .header-center {
            text-align: center;
            margin-bottom: 20px;
        }
        .header-center h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: #064e3b;
            margin: 0;
        }
        .header-center h2 {
            font-size: 0.9rem;
            font-weight: 400;
            color: #475569;
            margin: 4px 0 0;
            font-style: italic;
        }
        .landing-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            position: relative;
            overflow: hidden;
            border-radius: 12px;
        }
        .upload-box {
            position: relative;
            z-index: 1;
            border: 2px dashed #94a3b8;
            border-radius: 12px;
            padding: 40px 60px;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
        .upload-box:hover {
            background-color: #e2e8f0;
            border-color: #0284c7;
        }
        .upload-box .upload-icon {
            font-size: 4rem;
            color: #0284c7;
            margin-bottom: 10px;
        }
        .upload-box .upload-text {
            font-size: 1.2rem;
            color: #334155;
            font-weight: 500;
        }
        .upload-box .upload-subtext {
            color: #64748b;
            font-size: 0.9rem;
        }
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }
        .card {
            background: #f1f5f9;
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 1px 4px #0001;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: flex-start;
            min-height: 120px;
        }
        .card:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px #0002;
        }
        .card h3 { margin: 0; font-size: 1.1rem; color: #334155; }
        .card .value { font-size: 1.5rem; color: #1d4ed8; font-weight: bold; margin-top: 4px; }
        .card .subtext { font-size: 0.85rem; color: #475569; margin-top: 2px; }
        .card .chart-container { position: relative; display: flex; justify-content: center; align-items: center; margin-top: 6px; width: 100%; height: 80px; }
        .card canvas { width: 100% !important; height: 100% !important; }
        .controls {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            flex-wrap: wrap;
            background-color: #f8fafc;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        .control-group { display: flex; flex-direction: column; }
        .control-group label { font-size: 0.85rem; margin-bottom: 4px; color: #334155; }
        .control-group select,
        .control-group input,
        .control-group button {
            min-width: 140px; padding: 6px 10px; border-radius: 4px;
            border: 1px solid #d1d5db; background: #fff; cursor: pointer; font-size: 0.9rem;
        }
        .error-message { color: #b91c1c; margin-top: 8px; font-size: 0.9rem; }
        
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: flex; justify-content: center;
            align-items: center; z-index: 2000;
        }
        .modal {
            background: #fff; border-radius: 8px; padding: 0;
            max-width: 90vw; width: auto; max-height: 90vh;
            display: flex; flex-direction: column; box-shadow: 0 4px 20px #0003;
        }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 20px; border-bottom: 1px solid #e5e7eb;
        }
        .modal-header h3 { margin: 0; font-size: 1.2rem; }
        .modal-header .close-btn { background: transparent; border: none; font-size: 1.5rem; cursor: pointer; padding: 0; line-height: 1; }
        .modal-content { padding: 20px; overflow-y: auto; }
        .modal-footer {
            margin-top: auto; padding: 15px 20px; border-top: 1px solid #e5e7eb;
            display: flex; gap: 10px; justify-content: flex-end; background-color: #f9fafb;
            border-bottom-left-radius: 8px; border-bottom-right-radius: 8px;
        }
        .download-btn {
            background-color: #1d4ed8; color: white; border: none; padding: 8px 15px;
            border-radius: 5px; cursor: pointer; font-size: 0.9rem;
        }
        .excel-download-btn { background-color: #4CAF50; }
        .table-wrapper { position: relative; overflow-x: auto; max-height: 60vh; border-radius: 8px; border: 1px solid #e5e7eb; }
        .datatable-container { margin-top: 24px; }
        .datatable-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 0 5px; }
        .datatable-header h3 { margin: 0; font-size: 1.2rem; color: #334155; }
        table { border-collapse: collapse; width: 100%; font-size: 0.9rem; }
        .datatable-container table { min-width: 1800px; }
        th, td { padding: 10px 14px; border-bottom: 1px solid #e5e7eb; text-align: left; vertical-align: middle; }
        th { background: #f9fafb; position: sticky; top: 0; z-index: 3; font-size: 0.85rem; white-space: nowrap; }
        tr:nth-child(even) td { background: #fafafa; }
        tr:hover td { background: #eef2f7; }
        th:first-child, td:first-child { position: sticky; left: 0; background: inherit; z-index: 2; }
        .col-zemin, .col-personel, .col-kurum-ad, .col-ba≈üvuran, .col-tescil-talep-bilgisi, .col-ba≈üvuru-a√ßƒ±klama { white-space: normal; word-break: break-word; }
        .charts-below { display: flex; gap: 24px; margin-top: 20px; flex-wrap: nowrap; overflow-x: auto; }
        .chart-card {
            background: #f1f5f9; border-radius: 12px; padding: 14px 16px;
            min-width: 350px; flex: 1; box-shadow: 0 1px 4px #0001;
            display: flex; flex-direction: column; height: auto; position: relative;
        }
        .chart-card .chart-wrapper { height: 150px; width: 100%; margin-bottom: 10px; }
        .chart-card canvas { width: 100% !important; height: 100% !important; }
        .chart-title { font-size: 1rem; color: #334155; margin-bottom: 8px; }
        .zoom-btn {
            position: absolute; top: 10px; right: 10px; background: transparent;
            border: none; font-size: 1.2rem; cursor: pointer; color: #334155;
        }
        .warning-table-container { margin-top: 24px; padding: 16px; border-radius: 12px; border: 2px solid #ef4444; background: #fef2f2; }
        .warning-table-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .warning-table-header h3 { margin: 0; color: #991b1b; }
        .warning-table-header .button-group { display: flex; gap: 10px; }
        .warning-table-container table { table-layout: auto; }
        .warning-table-container .col-personel { width: 25%; min-width: 180px; }
        .warning-table-container .col-zemin { width: 40%; }
        
        .export-btn {
            background-color: #4CAF50; color: white; border: none; padding: 8px 12px;
            border-radius: 4px; cursor: pointer; font-size: 0.9rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
            transition: background-color 0.3s ease;
        }
        .export-btn:hover { background-color: #388E3C; }
        .personnel-waiting-list {
            margin-top: 15px; border-top: 1px solid #e2e8f0; padding-top: 10px;
            max-height: 150px; overflow-y: auto; position: relative;
        }
        .personnel-waiting-list h4 { margin: 0 0 8px 0; font-size: 0.9rem; color: #475569; }
        .personnel-waiting-list table { width: 100%; }
        .personnel-waiting-list td { padding: 4px 6px; border-bottom: 1px solid #f1f5f9; }
        .personnel-waiting-list td:last-child { text-align: right; font-weight: bold; color: #1e40af; }
        .zoomed-waiting-list-table thead th {
            position: sticky; top: -1px; 
            background-color: #ffffff; z-index: 1;
        }
        .filter-list { display: flex; flex-direction: column; gap: 5px; }
        .filter-item label {
            display: block; padding: 8px; border-radius: 4px; cursor: pointer;
            transition: background-color 0.2s;
        }
        .filter-item input { margin-right: 10px; }
        .filter-item label:hover { background-color: #f1f5f9; }
        
        /* AI Reporter Styles */
        .ai-reporter-container {
            margin-top: 24px;
            padding: 20px;
            border-radius: 12px;
            background-color: #f0f9ff;
            border: 1px solid #bae6fd;
        }
        .ai-reporter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .ai-reporter-header h3 {
            margin: 0;
            color: #0c4a6e;
            font-size: 1.3rem;
        }
        .ai-reporter-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        .ai-reporter-controls .control-group {
            min-width: 200px;
        }
        .ai-reporter-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .ai-reporter-actions button {
            background-color: #0ea5e9;
            color: white;
            padding: 8px 16px;
            font-weight: 500;
        }
        .ai-reporter-actions button.pdf-export {
            background-color: #db2777;
        }
        .ai-reporter-actions button:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }
        .ai-report-display {
            margin-top: 16px;
            padding: 20px;
            border-radius: 8px;
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
            color: #334155;
            min-height: 100px;
            font-family: 'Segoe UI', sans-serif;
            line-height: 1.7;
        }
        .ai-report-display h1, .ai-report-display h2, .ai-report-display h3 {
            color: #1e3a8a;
            margin-top: 1.2em;
            margin-bottom: 0.6em;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 4px;
        }
        .ai-report-display h1 { font-size: 1.5em; }
        .ai-report-display h2 { font-size: 1.3em; }
        .ai-report-display h3 { font-size: 1.1em; }
        .ai-report-display p { margin-bottom: 1em; }
        .ai-report-display ul { padding-left: 20px; margin-bottom: 1em; }
        .ai-report-display li { margin-bottom: 0.5em; }
        .ai-report-display strong { color: #1e40af; }


        @media (max-width: 600px) {
            .dashboard { grid-template-columns: 1fr; }
            .charts-below { flex-direction: column; overflow-x: visible; }
            .ai-reporter-controls {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        Chart.register(ChartDataLabels);

        const PROVINCES = ["Adana","Adƒ±yaman","Afyonkarahisar","Aƒürƒ±","Amasya","Ankara","Antalya","Artvin","Aydƒ±n","Balƒ±kesir","Bilecik","Bing√∂l","Bitlis","Bolu","Burdur","Bursa","√áanakkale","√áankƒ±rƒ±","√áorum","Denizli","Diyarbakƒ±r","Edirne","Elazƒ±ƒü","Erzincan","Erzurum","Eski≈üehir","Gaziantep","Giresun","G√ºm√º≈ühane","Hakkari","Hatay","Isparta","Mersin","ƒ∞stanbul","ƒ∞zmir","Kars","Kastamonu","Kayseri","Kƒ±rklareli","Kƒ±r≈üehir","Kocaeli","Konya","K√ºtahya","Malatya","Manisa","Kahramanmara≈ü","Mardin","Muƒüla","Mu≈ü","Nev≈üehir","Niƒüde","Ordu","Rize","Sakarya","Samsun","Siirt","Sinop","Sivas","Tekirdaƒü","Tokat","Trabzon","Tunceli","≈ûanlƒ±urfa","U≈üak","Van","Yozgat","Zonguldak","Aksaray","Bayburt","Karaman","Kƒ±rƒ±kkale","Batman","≈ûƒ±rnak","Bartƒ±n","Ardahan","Iƒüdƒ±r","Yalova","Karab√ºk","Kilis","Osmaniye","D√ºzce"];
        const ALLOWED_COLS = ["kurum ad","il√ße","ba≈üvuru tarihi","fen kayƒ±t tarihi","fen kayƒ±t no","ba≈üvuru no","ba≈üvuran","i≈ülem","zemin","g√∂revli personel","tescil talep bilgisi","ba≈üvuru durumu","ba≈üvuru a√ßƒ±klama","iade"];
        const HEADER_KEYWORDS = {"kurum ad":["kurum","ad"],"il√ße":["il√ße", "ad"],"ba≈üvuru tarihi":["ba≈üvuru","tarih"],"fen kayƒ±t tarihi":["fen","kayƒ±t","tarih"],"fen kayƒ±t no":["fen","kayƒ±t","no"],"ba≈üvuru no":["ba≈üvuru","no"],"ba≈üvuran":["ba≈üvuran"],"i≈ülem":["i≈ülem"],"zemin":["zemin"],"g√∂revli personel":["g√∂revli","personel"],"tescil talep bilgisi":["tescil","talep","bilgi"],"ba≈üvuru durumu":["ba≈üvuru","durum"],"ba≈üvuru a√ßƒ±klama":["ba≈üvuru","a√ßƒ±klama"],"iade":["iade"]};
        
        function normalizeHeader(header) { if (!header) return ""; let s; try { s = header.normalize('NFD').replace(/[\u0300-\u036f]/g, ''); } catch (e) { s = String(header); } s = s.trim().toLocaleLowerCase('tr').replace(/\s+/g, ' '); s = s.replace(/ƒ±/g, 'i').replace(/ƒ∞/g, 'i'); return s; }
        function splitPersonel(text) { if (text == null) return []; const str = typeof text === 'string' ? text : String(text); return str.split(/[,;‚Äì-]/g).map(s => { let part = s.trim(); const arrowIdx = part.indexOf('=>'); if (arrowIdx !== -1) part = part.slice(0, arrowIdx).trim(); return part; }).filter(Boolean); }
        function formatDate(val) { if (!val) return ""; if (typeof val === 'number') { const date = XLSX.SSF.parse_date_code(val); if (!date) return ""; return `${date.y}-${String(date.m).padStart(2,'0')}-${String(date.d).padStart(2,'0')}`; } if (typeof val === 'string') { let match = val.match(/^(\d{4}-\d{2}-\d{2})/); if (match) return match[1]; match = val.match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})/); if (match) { const day = String(match[1]).padStart(2, '0'); const month = String(match[2]).padStart(2, '0'); const year = match[3]; return `${year}-${month}-${day}`; } const part = val.split(" ")[0]; const m2 = part.match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})/); if (m2) { const day = String(m2[1]).padStart(2, '0'); const month = String(m2[2]).padStart(2, '0'); const year = m2[3]; return `${year}-${month}-${day}`; } return part; } return val; }
        function formatFenKayitNo(val) { if (val == null) return ""; if (typeof val === 'number') return val; if (typeof val === 'string') { const num = parseInt(val.replace(/\D/g,''),10); if (!isNaN(num)) return num; return val; } return val; }
        function detectProvinceAndDistrict(rawKurumAd) { if (!rawKurumAd) return {province: null, district: null}; const normRaw = normalizeHeader(rawKurumAd); let province = null, district = null; for (let p of PROVINCES) { if (normRaw.includes(normalizeHeader(p))) { province = p; let idx = normRaw.indexOf(normalizeHeader(p)); let after = normRaw.substring(idx + normalizeHeader(p).length).trim(); if (after.length > 0) { after = after.replace(/belediyesi|belediye|ilce|il√ße|merkez|buyuksehir|tapu mudurlugu|kadastro mudurlugu/gi, '').trim(); if (after.length > 0) district = after.split(' ')[0].replace(/[^a-zA-Z√ßƒüƒ±√∂≈ü√º√áƒûƒ∞√ñ≈û√ú\s]/g, ''); } break; } } return {province, district}; }
        
        function readExcelPromise(file) {
            return new Promise((resolve, reject) => {
                if (!file) { reject(new Error("Dosya y√ºklenmedi veya ge√ßersiz dosya.")); return; }
                const validTypes = ['application/vnd.openxmlformats-officedocument.spreadsheetml.sheet','application/vnd.ms-excel'];
                if (!validTypes.includes(file.type) && !file.name.match(/\.xlsx?$|\.xls?$/i)) { reject(new Error("L√ºtfen .xls veya .xlsx uzantƒ±lƒ± bir dosya se√ßin.")); return; }
                const reader = new FileReader();
                reader.onload = e => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const ws = workbook.Sheets[workbook.SheetNames[0]];
                        let json = XLSX.utils.sheet_to_json(ws, { header: 1, raw: true });
                        if (!json.length) { resolve([]); return; }
                        const rawHeaders = json[0].map(h => h == null ? "" : String(h));
                        const headersNorm = rawHeaders.map(h => normalizeHeader(h));
                        const colIndexes = {};
                        ALLOWED_COLS.forEach(col => { colIndexes[col] = -1; });
                        headersNorm.forEach((hNorm, idx) => { for (const canonical of ALLOWED_COLS) { const keywords = HEADER_KEYWORDS[canonical] || []; const allMatch = keywords.every(k => normalizeHeader(k) && hNorm.includes(normalizeHeader(k))); if (allMatch && colIndexes[canonical] === -1) { colIndexes[canonical] = idx; break; } } });
                        const allKurumAd = json.slice(1).map(row => { const idx = colIndexes["kurum ad"]; return idx >= 0 ? String(row[idx] || "") : ""; });
                        let provincesInFile = new Set();
                        for (let kurum of allKurumAd) { const {province} = detectProvinceAndDistrict(kurum); if (province) provincesInFile.add(province); }
                        let singleProvince = (provincesInFile.size === 1) ? Array.from(provincesInFile)[0] : null;
                        const rows = json.slice(1).map(row => {
                            const obj = {};
                            ALLOWED_COLS.forEach(col => {
                                const idx = colIndexes[col];
                                let val = idx >= 0 ? row[idx] : null;
                                if (col==='ba≈üvuru tarihi' || col==='fen kayƒ±t tarihi') obj[col]=formatDate(val);
                                else if(col==='fen kayƒ±t no'||col==='ba≈üvuru no') obj[col]=formatFenKayitNo(val);
                                else obj[col]=val??"";
                            });
                            let kurumAd = String(obj['kurum ad']||'').trim();
                            const {province, district} = detectProvinceAndDistrict(kurumAd);
                            if (singleProvince) {
                                obj._province = singleProvince;
                                obj._district = district || "";
                            } else {
                                obj._province = province || null;
                                obj._district = district || "";
                            }
                            return obj;
                        });
                        resolve(rows);
                    } catch(err) { console.error("readExcelPromise hata:", err); reject(new Error("Dosya okunurken hata olu≈ütu.")); }
                };
                reader.onerror = () => reject(new Error("Dosya okunamadƒ±."));
                try { reader.readAsArrayBuffer(file); } catch(err) { reject(new Error("Dosya okunurken beklenmedik hata olu≈ütu.")); }
            });
        }

        function calcMetrics(arr) {
            const today = new Date();
            const threeMonthsAgo = new Date();
            threeMonthsAgo.setMonth(today.getMonth() - 3);

            let toplam = arr.length, count2025 = 0, totalDays = 0, countDays = 0, overdue = 0;
            let yearCounts = {}, tescile = 0, iade = 0;

            arr.forEach(d => {
                const bStr = d['ba≈üvuru tarihi'];
                const fStr = d['fen kayƒ±t tarihi'];
                const fenKayitNo = d['fen kayƒ±t no'];

                if (bStr) {
                    const bd = new Date(bStr);
                    if (!isNaN(bd.getTime())) {
                        if (bd.getFullYear() === 2025) count2025++;
                        if (bd >= threeMonthsAgo && fStr) {
                            const fd = new Date(fStr);
                            if (!isNaN(fd.getTime()) && fd.getFullYear() > 1900) {
                                const diff = (fd - bd) / (1000 * 60 * 60 * 24);
                                if (!isNaN(diff) && diff >= 0) {
                                    totalDays += diff;
                                    countDays++;
                                }
                            }
                        }
                    }
                }
                const status = String(d['ba≈üvuru durumu'] || '').toLocaleLowerCase('tr');
                const excluded = status.includes('eksiklikten iade edildi') || status.includes('tescile g√∂nderildi');
                
                if (fStr && !excluded) {
                    const fd = new Date(fStr);
                    const hasValidFenKayitNo = fenKayitNo != null && fenKayitNo != 0;
                    if (!isNaN(fd.getTime()) && fd.getFullYear() > 1900 && hasValidFenKayitNo) {
                         const diff = (today - fd) / (1000 * 60 * 60 * 24);
                         if (diff >= 10) {
                              overdue++;
                         }
                    }
                }
                
                if(bStr && !excluded) {
                    const bd = new Date(bStr);
                    if (!isNaN(bd.getTime()) && bd.getFullYear() > 1900) {
                        const y = bd.getFullYear();
                        yearCounts[y] = (yearCounts[y] || 0) + 1;
                    }
                }

                if (status.includes('tescile g√∂nderildi')) tescile++;
                if (status.includes('eksiklikten iade edildi')) iade++;
            });

            const avgDays = countDays > 0 ? Math.round(totalDays / countDays) : 0;
            const totalWaiting = Object.values(yearCounts).reduce((a, b) => a + b, 0);
            return { toplam, count2025, avgDays, overdue, yearCounts, tescile, iade, totalWaiting };
        }
        
        function Dashboard({ data, filtered, sortField, selectedPersonel }) { 
            const baseArr = (selectedPersonel.length > 0 || filtered.length > 0) ? filtered : data; 
            const metrics = calcMetrics(baseArr); 
            const sumRef = useRef(), overdueRef = useRef(), yearRef = useRef(); 
            const sumChartRef = useRef(null), overdueChartRef = useRef(null), yearChartRef = useRef(null); 
            
            useEffect(() => { 
                try { 
                    if (sumRef.current) { if (sumChartRef.current) sumChartRef.current.destroy(); sumChartRef.current = new Chart(sumRef.current, { type:'pie', data:{ labels:['T√ºm√º'], datasets:[{ data:[metrics.toplam], backgroundColor:['hsl(0,70%,60%)'] }] }, options:{ responsive:true, plugins:{ legend:{ display:false } }, maintainAspectRatio:false } }); } 
                    if (overdueRef.current) { if (overdueChartRef.current) overdueChartRef.current.destroy(); overdueChartRef.current = new Chart(overdueRef.current, { type:'pie', data:{ labels:['10+ G√ºn Bekleyen'], datasets:[{ data:[metrics.overdue], backgroundColor:['#f87171'] }] }, options:{ responsive:true, plugins:{ legend:{ display:false } }, maintainAspectRatio:false } }); } 
                    if (yearRef.current) { if (yearChartRef.current) yearChartRef.current.destroy(); const years = Object.keys(metrics.yearCounts).sort(); const labels = years.map(y=>`${y}: ${metrics.yearCounts[y]}`); const dataVals = years.map(y=>metrics.yearCounts[y]); yearChartRef.current = new Chart(yearRef.current, { type:'pie', data:{ labels, datasets:[{ data:dataVals, backgroundColor: years.map((_,i)=>`hsl(${i*360/years.length},70%,60%)`) }] }, options:{ responsive:true, plugins:{ legend:{ position:'bottom', labels:{ boxWidth:12, padding:8 } }, tooltip:{ enabled:true } }, maintainAspectRatio:false } }); } 
                } catch(err) { console.error("Dashboard chart error:", err); } 
            }, [metrics]); 
            
            const yearLegend = Object.keys(metrics.yearCounts).sort().map((y,i)=>{ const color=`hsl(${i*360/Object.keys(metrics.yearCounts).length},70%,60%)`; return (<div key={y} style={{display:'flex',alignItems:'center',marginTop:'4px'}}><span style={{width:'12px',height:'12px',backgroundColor:color,display:'inline-block',marginRight:'6px',borderRadius:'2px'}}></span><span style={{fontSize:'0.85rem',color:'#334155'}}>{y}: {metrics.yearCounts[y]}</span></div>);}); 
            
            return (
                <div className="dashboard"> 
                    <div className="card"><h3>Toplam ƒ∞≈ülem</h3><span className="value">{metrics.toplam}</span><div className="subtext">2025 Ba≈üvuru: {metrics.count2025}</div><div className="chart-container"><canvas ref={sumRef}></canvas></div></div> 
                    <div className="card"><h3>F.K. Ort. S√ºre (Son 3 Ay)</h3><span className="value">{metrics.avgDays} g√ºn</span></div> 
                    <div className="card"><h3>10+ G√ºn Bekleyen</h3><span className="value">{metrics.overdue}</span><div className="chart-container"><canvas ref={overdueRef}></canvas></div></div> 
                    <div className="card"><h3>Yƒ±la G√∂re Bekleyen</h3><div className="chart-container"><canvas ref={yearRef}></canvas></div>{yearLegend}</div> 
                    <div className="card"><h3>Tescile Giden/ƒ∞ade</h3><span className="value">{metrics.tescile}/{metrics.iade}</span></div> 
                </div>
            ); 
        }
        
        function ChartsBelow({ data, onZoom, personnelChartCardRef }) { 
            const barRef = useRef(); 
            const barChartRef = useRef(null); 
            const [personnelStats, setPersonnelStats] = useState({ totals: {}, waiting: {} }); 
            
            useEffect(() => { 
                if (!data || data.length === 0) { setPersonnelStats({ totals: {}, waiting: {} }); return; } 
                const totalsMap = {}; const waitingMap = {}; 
                data.forEach(r => { 
                    const personnel = splitPersonel(r['g√∂revli personel']); 
                    if (personnel.length === 0) return; 
                    personnel.forEach(p => { if (p) totalsMap[p] = (totalsMap[p] || 0) + 1; }); 
                    const status = String(r['ba≈üvuru durumu'] || '').toLocaleLowerCase('tr'); 
                    const isClosed = status.includes('eksiklikten iade edildi') || status.includes('tescile g√∂nderildi'); 
                    if (!isClosed) { personnel.forEach(p => { if (p) waitingMap[p] = (waitingMap[p] || 0) + 1; }); } 
                }); 
                setPersonnelStats({ totals: totalsMap, waiting: waitingMap }); 
            }, [data]); 
            
            useEffect(() => { 
                try { 
                    if (barRef.current) { 
                        const labels = Object.keys(personnelStats.totals); 
                        const dataValues = Object.values(personnelStats.totals); 
                        if (barChartRef.current) barChartRef.current.destroy(); 
                        barChartRef.current = new Chart(barRef.current, { 
                            type:'bar', 
                            data:{ labels, datasets:[{ label:'Toplam ƒ∞≈ülem Sayƒ±sƒ±', data:dataValues, backgroundColor: labels.map((_,i)=>`hsl(${i*360/labels.length},70%,60%)`) }] }, 
                            options:{ responsive:true, plugins:{ legend:{ display:false }, datalabels: { anchor: 'end', align: 'top', color: '#444', font: { weight: 'bold' } } }, scales:{ y:{ beginAtZero:true } }, maintainAspectRatio:false } 
                        }); 
                    } 
                } catch(err) { console.error("ChartsBelow chart error:", err); } 
            }, [personnelStats.totals]); 
            
            const waitingList = Object.entries(personnelStats.waiting).map(([name, count]) => ({ name, count })).sort((a, b) => b.count - a.count); 
            
            if (!data || data.length===0) return null; 
            
            const waitingListContent = waitingList.length > 0 ? (
                waitingList.map(item => (
                    <tr key={item.name}>
                        <td>{item.name}</td>
                        <td>{item.count}</td>
                    </tr>
                ))
            ) : (
                <tr>
                    <td colSpan="2" style={{textAlign: 'center', color: '#6b7280'}}>Bekleyen i≈ülem yok.</td>
                </tr>
            );

            return ( 
                <div className="chart-card" ref={personnelChartCardRef}> 
                    <button className="zoom-btn" title="B√ºy√ºt" onClick={() => onZoom({type: 'chart', data: personnelStats.totals })}>üîç</button> 
                    <div className="chart-title">Personel ƒ∞≈ülem Daƒüƒ±lƒ±mƒ± (Toplam)</div> 
                    <div className="chart-wrapper"><canvas ref={barRef}></canvas></div> 
                    <div className="personnel-waiting-list"> 
                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}> 
                            <h4>Bekleyen ƒ∞≈ülem Sayƒ±larƒ±</h4> 
                           <button className="zoom-btn" style={{position: 'static', fontSize: '1rem'}} title="B√ºy√ºt" onClick={() => onZoom({type: 'waitingList', data: waitingList })}>üîç</button> 
                        </div> 
                        <table> 
                            <tbody> 
                                {waitingListContent}
                            </tbody> 
                        </table> 
                    </div> 
                </div> 
            ); 
        }
        
        function SummaryTable({ data, selectedIl, onZoom, summaryTableRef }) { 
            const groupArr = {}; 
            data.forEach(row => { 
                if (!row._province) return; 
                const groupKey = row._province; 
                if (!groupArr[groupKey]) groupArr[groupKey] = []; 
                groupArr[groupKey].push(row); 
            }); 
            const groupKeys = selectedIl && selectedIl.length > 0 ? Object.keys(groupArr).filter(gk => selectedIl.includes(gk)) : Object.keys(groupArr); 
            const rows = groupKeys.map(key => { 
                const arr = groupArr[key]; 
                const m = calcMetrics(arr); 
                return { key, ...m }; 
            }); 
            
            return ( 
                <div className="chart-card" style={{ position:'relative', minWidth:'auto', flex:'1 1 auto' }} ref={summaryTableRef}> 
                    {groupKeys.length>0 && <button className="zoom-btn" title="B√ºy√ºt" onClick={onZoom}>üîç</button>} 
                    <div className="chart-title">√ñzet Tablo</div> 
                    <div style={{overflowX:'auto',background:'#f1f5f9',borderRadius:'12px',padding:'12px',minWidth:'600px'}}> 
                        <table className="summary-table"> 
                            <thead> 
                                <tr> 
                                    <th>ƒ∞l</th><th>Toplam ƒ∞≈ülem</th><th>2025 Ba≈üvuru</th><th>F.K. Ort. S√ºre</th><th>10+ G√ºn</th><th>Tescile Giden</th><th>ƒ∞ade</th><th>Toplam Bekleyen</th> 
                                </tr> 
                            </thead> 
                            <tbody> 
                                {rows.length>0 ? rows.map(r=><tr key={r.key}> 
                                    <td>{r.key}</td> 
                                    <td>{r.toplam}</td> 
                                    <td>{r.count2025}</td> 
                                    <td>{r.avgDays} g√ºn</td> 
                                    <td>{r.overdue}</td> 
                                    <td>{r.tescile}</td> 
                                    <td>{r.iade}</td> 
                                    <td>{r.totalWaiting}</td> 
                                </tr>) : ( 
                                    <tr><td colSpan={8} style={{textAlign:'center',color:'#6b7280'}}>Veri bulunamadƒ±.</td></tr> 
                                )} 
                            </tbody> 
                        </table> 
                    </div> 
                </div> 
            ); 
        }
        
        function WarningTable({ data }) { 
            const [warningRows, setWarningRows] = useState([]); 
            useEffect(() => { 
                const today = new Date(); 
                const groupedTasks = {}; 
                data.forEach(task => { 
                    const fStr = task['fen kayƒ±t tarihi']; 
                    if (fStr) { 
                        const fenKayitDate = new Date(fStr); 
                        if (!isNaN(fenKayitDate) && fenKayitDate.getFullYear() > 1900) { 
                            const diffDays = (today - fenKayitDate) / (1000 * 60 * 60 * 24); 
                            const status = String(task['ba≈üvuru durumu']||'').toLocaleLowerCase('tr'); 
                            const isClosed = status.includes('eksiklikten iade edildi') || status.includes('tescile g√∂nderildi'); 
                            const fenKayitNo = task['fen kayƒ±t no']; 
                            const hasValidFenKayitNo = fenKayitNo != null && fenKayitNo != 0; 
                            if (diffDays >= 10 && !isClosed && hasValidFenKayitNo) { 
                                if (!groupedTasks[fenKayitNo]) { 
                                    groupedTasks[fenKayitNo] = { 
                                        fenKayitNo: fenKayitNo, 
                                        il: task._province || '', 
                                        ilce: task['il√ße'] || '', 
                                        zemin: task['zemin'] || '', 
                                        beklemeSuresi: Math.floor(diffDays), 
                                        personnel: splitPersonel(task['g√∂revli personel']) 
                                    }; 
                                } 
                            } 
                        } 
                    } 
                }); 
                const finalRows = Object.values(groupedTasks).sort((a, b) => b.beklemeSuresi - a.beklemeSuresi); 
                setWarningRows(finalRows); 
            }, [data]); 
            const handleExportWarningExcel = () => { 
                const dataToExport = warningRows.map(row => ({ 
                    'Personel': row.personnel.join("\n"), 
                    'Fen Kayƒ±t No': row.fenKayitNo, 
                    'ƒ∞l': row.il, 
                    'ƒ∞l√ße': row.ilce, 
                    'Zemin': row.zemin, 
                    'Bekleme S√ºresi (G√ºn)': row.beklemeSuresi 
                })); 
                const ws = XLSX.utils.json_to_sheet(dataToExport); 
                const range = XLSX.utils.decode_range(ws['!ref']); 
                for (let R = range.s.r + 1; R <= range.e.r; ++R) { 
                    const cell_address = { c: 0, r: R }; 
                    const cell_ref = XLSX.utils.encode_cell(cell_address); 
                    if (ws[cell_ref]) { 
                        if (!ws[cell_ref].s) ws[cell_ref].s = {}; 
                        ws[cell_ref].s.alignment = { wrapText: true }; 
                    } 
                } 
                ws['!cols'] = [ { wch: 30 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 40 }, { wch: 20 } ]; 
                const wb = XLSX.utils.book_new(); 
                XLSX.utils.book_append_sheet(wb, ws, 'Uyari Raporu'); 
                XLSX.writeFile(wb, 'uyari_raporu.xlsx'); 
            }; 
            if (warningRows.length === 0) { return null; } 
            return ( 
                <div className="warning-table-container"> 
                    <div className="warning-table-header"> 
                        <h3>10 G√ºnden Fazla Bekleyen ƒ∞≈ülemler (Uyarƒ±)</h3> 
                        <div className="button-group"> 
                            <button onClick={handleExportWarningExcel} className="export-btn" title="Excel olarak indir">Excel ƒ∞ndir</button> 
                        </div> 
                    </div> 
                    <div className="table-wrapper" style={{maxHeight: '300px'}}> 
                        <table> 
                            <thead> 
                                <tr> 
                                    <th className="col-personel">Personel</th> 
                                    <th className="col-fen-kayit-no">Fen Kayƒ±t No</th> 
                                    <th className="col-il">ƒ∞l</th> 
                                    <th className="col-ilce">ƒ∞l√ße</th> 
                                    <th className="col-zemin">Zemin</th> 
                                    <th className="col-bekleme-s√ºresi-g√ºn">Bekleme S√ºresi (G√ºn)</th> 
                                </tr> 
                            </thead> 
                            <tbody> 
                                {warningRows.map((row) => ( 
                                    <tr key={row.fenKayitNo}> 
                                        <td className="col-personel">
                                            {row.personnel.map((p, i) => (
                                                <React.Fragment key={i}>
                                                    {p}
                                                    {i < row.personnel.length - 1 && <br />}
                                                </React.Fragment>
                                            ))}
                                        </td>
                                        <td className="col-fen-kayit-no">{row.fenKayitNo}</td> 
                                        <td className="col-il">{row.il}</td> 
                                        <td className="col-ilce">{row.ilce}</td> 
                                        <td className="col-zemin">{row.zemin}</td> 
                                        <td className="col-bekleme-s√ºresi-g√ºn">{row.beklemeSuresi}</td> 
                                    </tr> 
                                ))} 
                            </tbody> 
                        </table> 
                    </div> 
                </div> 
            ); 
        }
        
        function DataTable({ data, sortField }) { 
            let rows = [...(data||[])]; 
            if(sortField==='iade edilen'){ rows=rows.filter(d=>String(d['ba≈üvuru durumu']||'').toLocaleLowerCase('tr').includes('eksiklikten iade edildi')); } 
            else if(sortField){ 
                rows.sort((a,b)=>{ 
                    const x=a[sortField]||'', y=b[sortField]||''; 
                    if(sortField.includes('tarih')){ const dx=new Date(x), dy=new Date(y); if(!isNaN(dx)&&!isNaN(dy)) return dx-dy; } 
                    return x<y?-1:x>y?1:0; 
                }); 
            } 
            const exportToExcel=()=>{ 
                try { 
                    const ws=XLSX.utils.json_to_sheet(rows.map(r=>{ const obj={}; ALLOWED_COLS.forEach(col => { obj[col.toLocaleUpperCase('tr-TR')] = r[col]; }); return obj; })); 
                    const wb=XLSX.utils.book_new(); 
                    XLSX.utils.book_append_sheet(wb,ws,'Tum_Islemler'); 
                    XLSX.writeFile(wb,'tum_islemler.xlsx'); 
                } catch(err) { console.error("Excel export error:", err); alert("Excel indirirken hata olu≈ütu."); } 
            }; 
            if(!rows) return null; 
            return (
                <div className="datatable-container"> 
                    <div className="datatable-header"> 
                        <h3>T√ºm ƒ∞≈ülemler</h3> 
                        <button className="export-btn" onClick={exportToExcel} title="Bu tabloyu Excel olarak indir">Excel ƒ∞ndir</button> 
                    </div> 
                    <div className="table-wrapper" style={{marginTop: 0}}> 
                        <table> 
                            <thead> 
                                <tr>{ALLOWED_COLS.map(col => <th key={col}>{col.toLocaleUpperCase('tr-TR')}</th>)}</tr> 
                            </thead> 
                            <tbody> 
                                {rows.map((row,i)=><tr key={i}>{ALLOWED_COLS.map(col => <td key={col} className={`col-${col.replace(/\s+/g, '-')}`}>{row[col]}</td>)}</tr>)} 
                                {rows.length===0&&<tr><td colSpan={ALLOWED_COLS.length} style={{textAlign:'center',color:'#6b7280'}}>Kayƒ±t bulunamadƒ±.</td></tr>} 
                            </tbody> 
                        </table> 
                    </div> 
                </div>
            ); 
        }
        
        const ZoomedChart = ({ chartData }) => { const canvasRef = useRef(null); const chartRef = useRef(null); useEffect(() => { if (canvasRef.current && chartData) { if (chartRef.current) chartRef.current.destroy(); const labels = Object.keys(chartData); const data = Object.values(chartData); chartRef.current = new Chart(canvasRef.current, { type:'bar', data:{ labels, datasets:[{ label:'Toplam ƒ∞≈ülem Sayƒ±sƒ±', data, backgroundColor: labels.map((_,i)=>`hsl(${i*360/labels.length},70%,60%)`) }] }, options:{ responsive:true, plugins:{ legend:{ display:false }, datalabels: { anchor: 'end', align: 'top', color: '#444', font: { weight: 'bold', size: 14 } } }, scales:{ y:{ beginAtZero:true } }, maintainAspectRatio:false } }); } }, [chartData]); return <div style={{width:'80vw', height:'70vh'}}><canvas ref={canvasRef}></canvas></div>; };
        const ZoomedSummary = ({ data, selectedIl }) => { return <SummaryTable data={data} selectedIl={selectedIl} onZoom={() => {}} />; };
        const ZoomedWaitingList = ({ data }) => { return ( <div style={{minWidth: '400px'}}> <div style={{maxHeight:'70vh', overflowY:'auto'}}> <table className="zoomed-waiting-list-table"> <thead> <tr> <th style={{position:'sticky', top:0, background: '#fff'}}>Personel</th> <th style={{textAlign: 'right', position:'sticky', top:0, background: '#fff'}}>Bekleyen ƒ∞≈ülem</th> </tr> </thead> <tbody> {data.length > 0 ? data.map(item => ( <tr key={item.name}> <td style={{width:'80%'}}>{item.name}</td> <td style={{width:'20%', textAlign: 'right'}}>{item.count}</td> </tr> )) : <tr><td colSpan="2" style={{textAlign:'center', color:'#6b7280'}}>Bekleyen i≈ülem yok.</td></tr>} </tbody> </table> </div> </div> ) };

        function AIReportGenerator({ data, ilOptions, personnelOptions, selectedIl }) {
            const [reportType, setReportType] = useState('il');
            const [selectedValue, setSelectedValue] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [generatedReport, setGeneratedReport] = useState('');
            const [reportHtml, setReportHtml] = useState('');
            const reportDisplayRef = useRef(null);

            const API_KEY = "AIzaSyAXPI6pT3qPGQ6JYQODz8mk-GZHV3t3oLA";
            const markdownConverter = new showdown.Converter();

            useEffect(() => {
                setSelectedValue('');
                setGeneratedReport('');
                setReportHtml('');
            }, [reportType]);

            const handleGenerateReport = async () => {
                const isComparative = reportType === 'kar≈üƒ±la≈ütƒ±rmalƒ±';
                if (!isComparative && !selectedValue) {
                    setGeneratedReport("L√ºtfen rapor i√ßin bir il veya personel se√ßin.");
                    setReportHtml("<p>L√ºtfen rapor i√ßin bir il veya personel se√ßin.</p>");
                    return;
                }
                if (isComparative && selectedIl.length < 2) {
                     setGeneratedReport("Kar≈üƒ±la≈ütƒ±rma i√ßin en az 2 il se√ßmelisiniz.");
                    setReportHtml("<p>Kar≈üƒ±la≈ütƒ±rma i√ßin en az 2 il se√ßmelisiniz. L√ºtfen √ºst men√ºdeki 'ƒ∞l Filtresi' butonunu kullanƒ±n.</p>");
                    return;
                }

                setIsLoading(true);
                setGeneratedReport('');
                setReportHtml('<p>Rapor olu≈üturuluyor, l√ºtfen bekleyin...</p>');

                const today = new Date();
                const formattedDate = today.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric' });
                let dataSummary = `Rapor Tarihi: ${formattedDate}\n`;
                let prompt;

                if (isComparative) {
                    dataSummary += `Rapor Kapsamƒ±: Kar≈üƒ±la≈ütƒ±rmalƒ± ƒ∞l Raporu - (${selectedIl.join(', ')})\n\n`;
                    selectedIl.forEach(il => {
                        const ilData = data.filter(d => d._province === il);
                        const metrics = calcMetrics(ilData);
                        dataSummary += `--- ${il} Verileri ---\n`;
                        dataSummary += `- Toplam ƒ∞≈ülem: ${metrics.toplam}\n- 10+ G√ºn Bekleyen: ${metrics.overdue}\n- Ort. F.K. S√ºresi: ${metrics.avgDays} g√ºn\n- Yƒ±llara G√∂re Bekleyen: ${JSON.stringify(metrics.yearCounts)}\n\n`;
                    });
                    
                    prompt = `
Sen, Tapu ve Kadastro Genel M√ºd√ºrl√ºƒü√º'nde √ßalƒ±≈üan uzman bir ba≈üm√ºfetti≈üsin. Sana sunulan ve birden fazla ili i√ßeren a≈üaƒüƒ±daki √∂zet verilere dayanarak, T√ºrk√ße dilinde, profesyonel ve resmi bir dille kar≈üƒ±la≈ütƒ±rmalƒ± bir performans raporu olu≈ütur.

√ñNEMLƒ∞ KURALLAR:
1.  **Performans Metrikleri:** Analizini SADECE '10+ G√ºn Bekleyen', 'Ort. F.K. S√ºresi' ve 'Yƒ±llara G√∂re Bekleyen' metriklerine dayandƒ±r. Bu metrikleri kullanarak illeri birbiriyle kƒ±yasla.
2.  **Format:** Raporu Markdown formatƒ±nda, ana ba≈ülƒ±klar (## Ba≈ülƒ±k) ve madde imleri (* Madde) kullanarak olu≈ütur.

RAPOR B√ñL√úMLERƒ∞:
-   **Tarih:** Raporun en ba≈üƒ±na, sana verdiƒüim Rapor Tarihi'ni **Tarih: [g√ºn ay yƒ±l]** formatƒ±nda ekle.
-   **## 1. Kar≈üƒ±la≈ütƒ±rmalƒ± Genel Bakƒ±≈ü:** Her ilin kritik performans metriklerini √∂zetle ve genel bir tablo √ßiz.
-   **## 2. Performans Liderleri:** Hangi ilin hangi metrikte (d√º≈ü√ºk bekleme s√ºresi, az bekleyen i≈ülem vb.) daha iyi performans g√∂sterdiƒüini belirt ve nedenlerini yorumla.
-   **## 3. Geli≈ütirilmesi Gereken Alanlar:** Hangi ilin hangi metriklerde zorlandƒ±ƒüƒ±nƒ± belirt ve potansiyel riskleri vurgula.

Bu 3 b√∂l√ºm dƒ±≈üƒ±nda ba≈üka bir b√∂l√ºm (√∂zellikle √∂neriler veya tavsiyeler b√∂l√ºm√º) KESƒ∞NLƒ∞KLE ekleme.

**Analiz Edilecek Veri √ñzeti:**
${dataSummary}
                    `;

                } else { // Single report
                    let filteredData = [];
                    if (reportType === 'il') {
                        filteredData = data.filter(d => d._province === selectedValue);
                    } else {
                        filteredData = data.filter(d => splitPersonel(d['g√∂revli personel']).includes(selectedValue));
                    }
                    const metrics = calcMetrics(filteredData);
                    dataSummary += `Rapor Kapsamƒ±: ${reportType === 'il' ? 'ƒ∞l' : 'Personel'} - ${selectedValue}\n`;
                    dataSummary += `- Toplam ƒ∞≈ülem Sayƒ±sƒ±: ${metrics.toplam}\n- 10 G√ºnden Fazla Bekleyen ƒ∞≈ülem Sayƒ±sƒ±: ${metrics.overdue}\n- Ortalama Fen Kayƒ±t S√ºresi (Son 3 Ay): ${metrics.avgDays} g√ºn\n- Tescile G√∂nderilen ƒ∞≈ülem Sayƒ±sƒ±: ${metrics.tescile}\n- ƒ∞ade Edilen ƒ∞≈ülem Sayƒ±sƒ±: ${metrics.iade}\n- Yƒ±llara G√∂re Bekleyen ƒ∞≈ülem Sayƒ±larƒ±: ${JSON.stringify(metrics.yearCounts)}`;

                    prompt = `
Sen, Tapu ve Kadastro Genel M√ºd√ºrl√ºƒü√º'nde √ßalƒ±≈üan uzman bir ba≈üm√ºfetti≈üsin. Sana sunulan a≈üaƒüƒ±daki √∂zet verilere dayanarak, T√ºrk√ße dilinde, profesyonel ve resmi bir dille 3 b√∂l√ºmden olu≈üan bir performans raporu olu≈ütur.

√ñNEMLƒ∞ KURALLAR:
1.  **ƒ∞ade Sayƒ±sƒ±:** 'ƒ∞ade Edilen ƒ∞≈ülem Sayƒ±sƒ±' bir performans metriƒüi deƒüildir. Bu sayƒ±yƒ± olumlu veya olumsuz bir performans g√∂stergesi olarak ASLA yorumlama. Sadece bilgi olarak not edebilirsin, ancak performansƒ± etkilediƒüini belirtme.
2.  **Performans Metrikleri:** Performans analizini ve yorumlarƒ±nƒ± SADECE ≈üu metriklere dayandƒ±r: 'bekleyen i≈ülem sayƒ±sƒ±', 'fen kayƒ±t s√ºresi' ve '10 g√ºnden fazla bekleyen i≈ülem sayƒ±sƒ±'.
3.  **Format:** Raporu Markdown formatƒ±nda, ana ba≈ülƒ±klar (## Ba≈ülƒ±k) ve madde imleri (* Madde) kullanarak olu≈ütur.

RAPOR B√ñL√úMLERƒ∞:
-   **Tarih:** Raporun en ba≈üƒ±na, sana verdiƒüim Rapor Tarihi'ni **Tarih: [g√ºn ay yƒ±l]** formatƒ±nda ekle.
-   **## 1. Genel Durum Deƒüerlendirmesi:** Verilerin genel bir √∂zeti.
-   **## 2. Olumlu Y√∂nler:** Kritik performans metriklerine g√∂re √∂ne √ßƒ±kan olumlu g√∂stergeler.
-   **## 3. Geli≈ütirilmesi Gereken Alanlar ve Potansiyel Riskler:** Kritik performans metriklerindeki olumsuzluklar ve potansiyel riskler.

Bu 3 b√∂l√ºm dƒ±≈üƒ±nda ba≈üka bir b√∂l√ºm (√∂zellikle √∂neriler veya tavsiyeler b√∂l√ºm√º) KESƒ∞NLƒ∞KLE ekleme.

**Analiz Edilecek Veri √ñzeti:**
${dataSummary}
                    `;
                }

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }),
                    });

                    if (!response.ok) {
                        const errorBody = await response.json();
                        throw new Error(`API hatasƒ±: ${response.status} ${response.statusText} - ${JSON.stringify(errorBody)}`);
                    }

                    const result = await response.json();
                    const reportText = result.candidates[0].content.parts[0].text;
                    setGeneratedReport(reportText);
                    setReportHtml(markdownConverter.makeHtml(reportText));

                } catch (error) {
                    console.error("Gemini API error:", error);
                    const errorMsg = `Rapor olu≈üturulurken bir hata olu≈ütu: ${error.message}. L√ºtfen API anahtarƒ±nƒ±zƒ± veya internet baƒülantƒ±nƒ±zƒ± kontrol edin.`;
                    setGeneratedReport(errorMsg);
                    setReportHtml(`<p style="color: red;">${errorMsg}</p>`);
                } finally {
                    setIsLoading(false);
                }
            };
            
            const handleExportToPdf = () => {
                const reportElement = reportDisplayRef.current;
                if (!reportElement || !generatedReport) {
                    console.error("Rapor verisi veya element bulunamadƒ±.");
                    return;
                }
                
                const { jsPDF } = window.jspdf;
                html2canvas(reportElement, { scale: 2 }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    const canvasWidth = canvas.width;
                    const canvasHeight = canvas.height;
                    const ratio = canvasWidth / canvasHeight;
                    const imgWidth = pdfWidth - 20; // 10mm margin on each side
                    const imgHeight = imgWidth / ratio;
                    
                    let heightLeft = imgHeight;
                    let position = 10; // top margin

                    pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
                    heightLeft -= (pdfHeight - 20);

                    while (heightLeft > 0) {
                        position = heightLeft - imgHeight; 
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
                        heightLeft -= (pdfHeight - 20);
                    }
                    
                    pdf.save("YapayZeka_Raporu.pdf");
                });
            };

            const options = reportType === 'il' ? ilOptions : personnelOptions;
            const isComparative = reportType === 'kar≈üƒ±la≈ütƒ±rmalƒ±';
            const canGenerate = !isLoading && (isComparative ? selectedIl.length > 1 : !!selectedValue);

            return (
                <div className="ai-reporter-container">
                    <div className="ai-reporter-header">
                        <h3>Yapay Zeka Destekli Raporlama</h3>
                    </div>
                    <div className="ai-reporter-controls">
                        <div className="control-group">
                            <label>Rapor T√ºr√º</label>
                            <select value={reportType} onChange={e => setReportType(e.target.value)}>
                                <option value="il">ƒ∞l Bazƒ±nda</option>
                                <option value="personel">Personel Bazƒ±nda</option>
                                <option value="kar≈üƒ±la≈ütƒ±rmalƒ±">Kar≈üƒ±la≈ütƒ±rmalƒ± ƒ∞l Raporu</option>
                            </select>
                        </div>
                        {!isComparative && (
                            <div className="control-group">
                                <label>{reportType === 'il' ? 'ƒ∞l Se√ßin' : 'Personel Se√ßin'}</label>
                                <select value={selectedValue} onChange={e => setSelectedValue(e.target.value)} disabled={options.length === 0}>
                                    <option value="">-- Se√ßim Yapƒ±n --</option>
                                    {options.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                                </select>
                            </div>
                        )}
                        <div className="ai-reporter-actions">
                             <button onClick={handleGenerateReport} disabled={!canGenerate}>
                                {isLoading ? 'Olu≈üturuluyor...' : 'Rapor Olu≈ütur'}
                            </button>
                            <button onClick={handleExportToPdf} className="pdf-export" disabled={isLoading || !generatedReport}>
                                PDF Olarak ƒ∞ndir
                            </button>
                        </div>
                    </div>
                     {isComparative && <p style={{marginTop: '10px', color: '#0c4a6e'}}><i>Kar≈üƒ±la≈ütƒ±rma yapƒ±lacak illeri √ºst men√ºdeki 'ƒ∞l Filtresi' butonundan se√ßebilirsiniz. (En az 2 il se√ßilmelidir)</i></p>}
                    <div className="ai-report-display" ref={reportDisplayRef} dangerouslySetInnerHTML={{ __html: reportHtml || '<p>Olu≈üturulan rapor burada g√∂r√ºnecektir.</p>' }}>
                    </div>
                </div>
            );
        }

        function App(){
            const [data,setData]=useState([]);
            const [loading,setLoading]=useState(false);
            const [errorMsg,setErrorMsg]=useState("");
            const [sortField,setSortField]=useState('');
            const [selectedPersonel,setSelectedPersonel]=useState([]);
            const [selectedIl,setSelectedIl]=useState([]);
            const [showPersonelModal,setShowPersonelModal]=useState(false);
            const [showIlModal,setShowIlModal]=useState(false);
            const [zoomContent, setZoomContent] = useState(null);

            const modalContentRef = useRef(null);
            
            const handleFile=async(e)=>{
                const files=Array.from(e.target.files||[]);
                if(!files.length) return;
                setLoading(true); setErrorMsg("");
                const newRows = await Promise.all(files.map(f => readExcelPromise(f).catch(err => {
                    console.error('Excel okuma hatasƒ±:',err); 
                    setErrorMsg(err.message);
                    return [];
                })));
                setData(prevData => [...prevData, ...newRows.flat()]); 
                e.target.value = null;
                setLoading(false);
            };
            
            const handleDownloadModalAsJpeg = () => {
                const elementToCapture = modalContentRef.current;
                if (elementToCapture) {
                    setLoading(true);
                    html2canvas(elementToCapture, {scale: 2, backgroundColor: '#ffffff'}).then(canvas => {
                        const url = canvas.toDataURL('image/jpeg', 1.0);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `${zoomContent.type}_gorunumu.jpg`;
                        a.click();
                    }).finally(() => setLoading(false));
                }
            };
            
            const handleExportWaitingListExcel = () => {
                if (zoomContent && zoomContent.type === 'waitingList') {
                    const dataToExport = zoomContent.data.map(i => ({'Personel': i.name, 'Bekleyen ƒ∞≈ülem Sayƒ±sƒ±': i.count}));
                    const ws = XLSX.utils.json_to_sheet(dataToExport);
                    ws['!cols'] = [{ wch: 30 }, { wch: 20 }];
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, 'Bekleyen_Islemler');
                    XLSX.writeFile(wb, 'bekleyen_islem_sayilari.xlsx');
                }
            };

            const ilOptions = Array.from(new Set(data.map(d=>d._province).filter(p=>p))).sort((a,b)=>a.localeCompare(b,'tr'));
            const personnelOptions = Array.from(new Set(data.flatMap(d=>splitPersonel(d['g√∂revli personel'])))).sort((a,b)=>a.localeCompare(b,'tr'));
            const sortOptions=[{label:'Sƒ±ralama Yok',value:''},{label:'Ba≈üvuru Tarihine G√∂re',value:'ba≈üvuru tarihi'},{label:'Fen Kayƒ±t Tarihine G√∂re',value:'fen kayƒ±t tarihi'},{label:'ƒ∞ade Edilen',value:'iade edilen'}];
            const filteredData=(() => {
                let arr=[...data];
                if(selectedIl.length>0) arr=arr.filter(d=>selectedIl.includes(d._province));
                if(selectedPersonel.length>0) arr=arr.filter(d=>{const ppl=splitPersonel(d['g√∂revli personel']); return selectedPersonel.some(sp=>ppl.includes(sp));});
                if(sortField==='iade edilen') arr=arr.filter(d=>String(d['ba≈üvuru durumu']||'').toLocaleLowerCase('tr').includes('eksiklikten iade edildi'));
                return arr;
            })();
            
            const LandingPage = ({onFileChange}) => (
                <div className="landing-container">
                    <label htmlFor="file-upload-landing" className="upload-box">
                        <div className="upload-icon">üì§</div>
                        <div className="upload-text">Analiz i√ßin Excel Dosyasƒ± Se√ßin</div>
                        <div className="upload-subtext">veya dosyayƒ± buraya s√ºr√ºkleyip bƒ±rakƒ±n</div>
                    </label>
                    <input id="file-upload-landing" type="file" multiple onChange={onFileChange} accept=".xlsx, .xls" style={{display: 'none'}} />
                </div>
            );

            return (<div className="container">
                <div className="header-center">
                    <h1>MEGSƒ∞S ƒ∞≈û TAKƒ∞P</h1>
                    <h2 style={{fontStyle: 'italic', fontSize: '0.9rem', color: '#64748b'}}>
                        by G√∂khan ELG√úL
                    </h2>
                </div>
                
                {data.length === 0 && !loading && !errorMsg && <LandingPage onFileChange={handleFile} />}
                {loading && <p style={{textAlign:'center'}}>Y√ºkleniyor...</p>}
                {errorMsg && <p className="error-message">{errorMsg}</p>}
                
                {data.length > 0 && <>
                    <div className="controls">
                         <div className="control-group">
                            <label>Dosya ƒ∞≈ülemleri</label>
                            <input type="file" multiple onChange={handleFile} accept=".xlsx, .xls" />
                        </div>
                        <div className="control-group">
                            <label>Sƒ±ralama</label>
                            <select value={sortField} onChange={e=>setSortField(e.target.value)}>
                                {sortOptions.map(o=><option key={o.value} value={o.value}>{o.label}</option>)}
                            </select>
                        </div>
                        <div className="control-group">
                            <label>ƒ∞l Filtresi</label>
                            <button onClick={()=>setShowIlModal(true)}>{selectedIl.length ? `${selectedIl.length} il se√ßili` : 'ƒ∞l Se√ß'}</button>
                        </div>
                        <div className="control-group">
                            <label>Personel Filtresi</label>
                            <button onClick={()=>setShowPersonelModal(true)}>{selectedPersonel.length ? `${selectedPersonel.length} personel se√ßili` : 'Personel Se√ß'}</button>
                        </div>
                         <div className="control-group">
                            <label>Veri Y√∂netimi</label>
                            <button onClick={() => { setData([]); setSelectedIl([]); setSelectedPersonel([]); }} style={{backgroundColor: '#ef4444', color: 'white'}}>Verileri Temizle</button>
                        </div>
                    </div>
                    <Dashboard data={data} filtered={filteredData} sortField={sortField} selectedPersonel={selectedPersonel} />
                    <div className="charts-below">
                        <ChartsBelow data={filteredData} onZoom={setZoomContent} />
                        <SummaryTable data={filteredData} selectedIl={selectedIl} onZoom={() => setZoomContent({type: 'summary'})} />
                    </div>
                    <WarningTable data={filteredData} />
                    <DataTable data={filteredData} sortField={sortField} />
                    <AIReportGenerator data={data} ilOptions={ilOptions} personnelOptions={personnelOptions} selectedIl={selectedIl} />
                </>}
                
                {zoomContent && (
                    <div className="modal-overlay" onClick={() => setZoomContent(null)}>
                        <div className="modal" onClick={e => e.stopPropagation()}>
                           <div className="modal-header">
                                <h3>{
                                    zoomContent.type === 'chart' ? 'Personel ƒ∞≈ülem Daƒüƒ±lƒ±mƒ± (B√ºy√ºk G√∂r√ºn√ºm)' 
                                    : zoomContent.type === 'summary' ? '√ñzet Tablo (B√ºy√ºk G√∂r√ºn√ºm)' 
                                    : 'Bekleyen ƒ∞≈ülem Sayƒ±larƒ±'
                                }</h3>
                                <button className="close-btn" onClick={() => setZoomContent(null)}>√ó</button>
                           </div>
                           <div className="modal-content" ref={modalContentRef}>
                                {zoomContent.type === 'chart' && <ZoomedChart chartData={zoomContent.data} />}
                                {zoomContent.type === 'summary' && <ZoomedSummary data={filteredData} selectedIl={selectedIl} />}
                                {zoomContent.type === 'waitingList' && <ZoomedWaitingList data={zoomContent.data} />}
                           </div>
                           <div className="modal-footer">
                                {zoomContent.type === 'waitingList' ?
                                    <button className="download-btn excel-download-btn" onClick={handleExportWaitingListExcel}>Excel ƒ∞ndir</button>
                                    :
                                    <button className="download-btn" onClick={handleDownloadModalAsJpeg}>JPEG ƒ∞ndir</button>
                                }
                           </div>
                        </div>
                    </div>
                )}

                {showIlModal && (
                    <div className="modal-overlay" onClick={() => setShowIlModal(false)}>
                        <div className="modal" onClick={e => e.stopPropagation()}>
                            <div className="modal-header"><h3>ƒ∞l Se√ß</h3><button className="close-btn" onClick={()=>setShowIlModal(false)}>√ó</button></div>
                            <div className="modal-content">
                                <div className="filter-list">
                                    {ilOptions.map(il => <div className="filter-item" key={il}><label>
                                        <input type="checkbox" checked={selectedIl.includes(il)} onChange={e=>{
                                            if(e.target.checked) setSelectedIl([...selectedIl,il]);
                                            else setSelectedIl(selectedIl.filter(p=>p!==il));
                                        }}/> {il}
                                    </label></div>)}
                                </div>
                            </div>
                            <div className="modal-footer"><button className="download-btn" onClick={()=>{setSelectedIl([]); setShowIlModal(false);}}>Temizle & Kapat</button></div>
                        </div>
                    </div>
                )}
                {showPersonelModal && (
                    <div className="modal-overlay" onClick={() => setShowPersonelModal(false)}>
                        <div className="modal" onClick={e => e.stopPropagation()}>
                             <div className="modal-header"><h3>Personel Se√ß</h3><button className="close-btn" onClick={()=>setShowPersonelModal(false)}>√ó</button></div>
                             <div className="modal-content">
                                <div className="filter-list">
                                    {personnelOptions.map(p => <div className="filter-item" key={p}><label>
                                        <input type="checkbox" checked={selectedPersonel.includes(p)} onChange={e=>{
                                            if(e.target.checked) setSelectedPersonel([...selectedPersonel,p]);
                                            else setSelectedPersonel(selectedPersonel.filter(sp=>sp!==p));
                                        }}/> {p}
                                    </label></div>)}
                                </div>
                            </div>
                            <div className="modal-footer"><button className="download-btn" onClick={()=>{setSelectedPersonel([]); setShowPersonelModal(false);}}>Temizle & Kapat</button></div>
                        </div>
                    </div>
                )}
            </div>);
        }
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
